<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <link rel="icon" href="/favicon.ico"><link rel="manifest" href="/manifest.webmanifest"><meta name="theme-color" content="#5397d2"><script>
      var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?e772d8d7735057378a672ae311e9bf20";
  var s = document.getElementsByTagName("script")[0];
  s.parentNode.insertBefore(hm, s);
})();
    </script><title>经过路由器的主机间通信 | 众里千寻</title><meta name="description" content="介绍需要经过路由器的两个主机间的通信过程，以及路由器的功能。"><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><meta name="generator" content="VuePress 2.0.0-beta.22">
    <link rel="preload" href="/assets/js/runtime~app.fa50ff6a.js" as="script"><link rel="preload" href="/assets/css/styles.e0095a00.css" as="style"><link rel="preload" href="/assets/js/3767.b5b9e7ce.js" as="script"><link rel="preload" href="/assets/js/app.8de2a662.js" as="script">
    <link rel="stylesheet" href="/assets/css/styles.e0095a00.css">
  </head>
  <body>
    <div id="app"><!--[--><div class="theme-container"><header class="navbar"><div class="toggle-sidebar-button"><svg class="icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div><span><a href="/" class=""><img class="logo" src="/hero-c.png" alt="众里千寻"><span class="site-name can-hide">众里千寻</span></a></span><div class="navbar-links-wrapper" style=""><!--[--><!--]--><nav class="navbar-links can-hide"><!--[--><div class="navbar-links-item"><a href="/courses/" class="nav-link router-link-active" aria-label="学习笔记"><!--[--><!--]--> 学习笔记 <!--[--><!--]--></a></div><div class="navbar-links-item"><a href="/solutions/" class="nav-link" aria-label="解决方案"><!--[--><!--]--> 解决方案 <!--[--><!--]--></a></div><div class="navbar-links-item"><a href="/tools/" class="nav-link" aria-label="开发利器"><!--[--><!--]--> 开发利器 <!--[--><!--]--></a></div><div class="navbar-links-item"><a href="/code-reading/" class="nav-link" aria-label="源码解读"><!--[--><!--]--> 源码解读 <!--[--><!--]--></a></div><div class="navbar-links-item"><a href="/posts/" class="nav-link" aria-label="最新消息"><!--[--><!--]--> 最新消息 <!--[--><!--]--></a></div><div class="navbar-links-item"><a class="nav-link external" href="https://github.com/everfind" rel="noopener noreferrer" target="_blank" aria-label="GitHub"><!--[--><!--]--> GitHub <span><svg class="icon outbound" xmlns="http://www.w3.org/2000/svg" ariahidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><!--[--><span class="sr-only">open in new window</span><!--]--></span><!--[--><!--]--></a></div><!--]--></nav><!--[--><!--]--><button class="toggle-dark-button"><svg style="" class="icon" focusable="false" viewBox="0 0 32 32"><path d="M16 12.005a4 4 0 1 1-4 4a4.005 4.005 0 0 1 4-4m0-2a6 6 0 1 0 6 6a6 6 0 0 0-6-6z" fill="currentColor"></path><path d="M5.394 6.813l1.414-1.415l3.506 3.506L8.9 10.318z" fill="currentColor"></path><path d="M2 15.005h5v2H2z" fill="currentColor"></path><path d="M5.394 25.197L8.9 21.691l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 25.005h2v5h-2z" fill="currentColor"></path><path d="M21.687 23.106l1.414-1.415l3.506 3.506l-1.414 1.414z" fill="currentColor"></path><path d="M25 15.005h5v2h-5z" fill="currentColor"></path><path d="M21.687 8.904l3.506-3.506l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 2.005h2v5h-2z" fill="currentColor"></path></svg><svg style="display:none;" class="icon" focusable="false" viewBox="0 0 32 32"><path d="M13.502 5.414a15.075 15.075 0 0 0 11.594 18.194a11.113 11.113 0 0 1-7.975 3.39c-.138 0-.278.005-.418 0a11.094 11.094 0 0 1-3.2-21.584M14.98 3a1.002 1.002 0 0 0-.175.016a13.096 13.096 0 0 0 1.825 25.981c.164.006.328 0 .49 0a13.072 13.072 0 0 0 10.703-5.555a1.01 1.01 0 0 0-.783-1.565A13.08 13.08 0 0 1 15.89 4.38A1.015 1.015 0 0 0 14.98 3z" fill="currentColor"></path></svg></button><form class="search-box" role="search"><input type="search" autocomplete="off" spellcheck="false" value><!----></form></div></header><div class="sidebar-mask"></div><aside class="sidebar"><nav class="navbar-links"><!--[--><div class="navbar-links-item"><a href="/courses/" class="nav-link router-link-active" aria-label="学习笔记"><!--[--><!--]--> 学习笔记 <!--[--><!--]--></a></div><div class="navbar-links-item"><a href="/solutions/" class="nav-link" aria-label="解决方案"><!--[--><!--]--> 解决方案 <!--[--><!--]--></a></div><div class="navbar-links-item"><a href="/tools/" class="nav-link" aria-label="开发利器"><!--[--><!--]--> 开发利器 <!--[--><!--]--></a></div><div class="navbar-links-item"><a href="/code-reading/" class="nav-link" aria-label="源码解读"><!--[--><!--]--> 源码解读 <!--[--><!--]--></a></div><div class="navbar-links-item"><a href="/posts/" class="nav-link" aria-label="最新消息"><!--[--><!--]--> 最新消息 <!--[--><!--]--></a></div><div class="navbar-links-item"><a class="nav-link external" href="https://github.com/everfind" rel="noopener noreferrer" target="_blank" aria-label="GitHub"><!--[--><!--]--> GitHub <span><svg class="icon outbound" xmlns="http://www.w3.org/2000/svg" ariahidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><!--[--><span class="sr-only">open in new window</span><!--]--></span><!--[--><!--]--></a></div><!--]--></nav><!--[--><!--]--><ul class="sidebar-links"><!--[--><!--[--><p class="sidebar-heading sidebar-item">经过路由器的主机间通信</p><ul class=""><li><!--[--><a aria-current="page" href="/courses/network/host-router-host.html#路由器的功能" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="路由器的功能"><!--[--><!--]--> 路由器的功能 <!--[--><!--]--></a><ul class="sidebar-sub-items"><li><!--[--><a aria-current="page" href="/courses/network/host-router-host.html#填充路由表" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="填充路由表"><!--[--><!--]--> 填充路由表 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a aria-current="page" href="/courses/network/host-router-host.html#填充-arp-表" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="填充 ARP 表"><!--[--><!--]--> 填充 ARP 表 <!--[--><!--]--></a><!----><!--]--></li></ul><!--]--></li><li><!--[--><a aria-current="page" href="/courses/network/host-router-host.html#路由器是如何工作的" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="路由器是如何工作的"><!--[--><!--]--> 路由器是如何工作的 <!--[--><!--]--></a><ul class="sidebar-sub-items"><li><!--[--><a aria-current="page" href="/courses/network/host-router-host.html#主机-a-到-r1" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="主机 A 到 R1"><!--[--><!--]--> 主机 A 到 R1 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a aria-current="page" href="/courses/network/host-router-host.html#指向接口的路由" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="指向接口的路由"><!--[--><!--]--> 指向接口的路由 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a aria-current="page" href="/courses/network/host-router-host.html#指向下一跳-ip-的路由" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="指向下一跳 IP 的路由"><!--[--><!--]--> 指向下一跳 IP 的路由 <!--[--><!--]--></a><!----><!--]--></li></ul><!--]--></li><li><!--[--><a aria-current="page" href="/courses/network/host-router-host.html#总结" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="总结"><!--[--><!--]--> 总结 <!--[--><!--]--></a><!----><!--]--></li></ul><!--]--><!--]--></ul><!--[--><!--]--></aside><main class="page"><!--[--><!--]--><div class="theme-default-content"><!--[--><p>前面我们讨论了两个直接相连的主机间的通信和经过交换机的主机间通信，本篇我们来说说经过路由器的主机间通信。</p><p>为了方便讨论，我们将使用下图来进行说明。我们会关注路由器 R1，以及它将数据包从主机 A 转发到主机 B 和主机 C 分别需要什么。</p><p><img src="/courses/network/host-router-host-c.png" alt="经过路由器的主机间通信"></p><blockquote><p>为了简便起见，图中我们仅使用四位十六进制数表示 MAC 地址。</p></blockquote><h2 id="路由器的功能" tabindex="-1"><a class="header-anchor" href="#路由器的功能" aria-hidden="true">#</a> 路由器的功能</h2><p>前面我们提到路由器的主要功能是促进网络之间的通信。每个路由器都会在两个网络之间创建一个边界，它们的主要作用是将数据包从一个网络转发到另一个网络。</p><p>在上图中，路由器 R1 在网络 11.11.11.x 和网络 22.22.22.x 之间创建了一个边界。路由器 R2 在网络 22.22.22.x 和网络 33.33.33.x 之间创建了一个边界。两个路由器在网络 22.22.22.x 中都有一个接口。</p><p>为了在网络之间转发数据包，路由器必须执行两项功能：填充和维护路由表，以及填充和维护 ARP 表。</p><h3 id="填充路由表" tabindex="-1"><a class="header-anchor" href="#填充路由表" aria-hidden="true">#</a> 填充路由表</h3><p>路由表中保存了现有所有的网络。路由表开始时为空，路由器在获知到每个网络的新路由时填充会填充它。</p><p>路由器可以通过多种方式了解每个网络的路由。我们将在本节中讨论其中的两个。</p><p>直连路由（ Directly Connected route）是最简单直接的方法。当路由器接口配置了特定的 IP 地址时，路由器将知道它直接连接到的网络。</p><p>例如，在上图中，R1 的左侧接口配置了 IP 地址 11.11.11.1。这告诉 R1 网络 11.11.11.x 的位置存在于其左侧接口之外。同样，R1 获悉 22.22.22.x 网络位于其右侧接口上。</p><p>当然，路由器不能直接连接到每个网络。在上图中，R1 未连接到 33.33.33.x，但 R1 有需要将数据包发送给网络 33.33.33.x。这时候就需要借助于静态路由的方法。</p><p>静态路由（Static Route）是由管理员手动配置的路由。就好像你明确告诉 R1 网络 33.33.33.x 存在于 R2 之后，为了到达它，R1 必须将数据包发送到 R2 的接口（配置了 IP 地址 22.22.22.2）。</p><p>最后，在 R1 获悉两条直连路由后，并在 R1 配置了一条静态路由后，R1 将拥有一个类似于下图的路​​由表。</p><p><img src="/courses/network/routing-table-c.png" alt="路由表"></p><p>路由表里记录了许多路由。每个路由都包含网络到接口或下一跳地址的映射。</p><p>每当路由器收到一个数据包，它就会查询路由表来决定如何转发这个数据包。如果接收到的数据包中，目标地址不在路由表内，那么路由器会认为这个网络不存在，会丢弃这个数据包。</p><p>除了上面两种方法以外，还有一种方法，动态路由（Dynamic Routing）。路由器之间会自动检测并相互通信，以告知彼此已知的路由。动态路由有很多种协议实现，考虑到复杂性，本文不做详细的说明。</p><h3 id="填充-arp-表" tabindex="-1"><a class="header-anchor" href="#填充-arp-表" aria-hidden="true">#</a> 填充 ARP 表</h3><p>我们知道，第二层负责传输数据，因此，路由器还需要借助于 ARP 协议来获取 MAC 地址，这些信息被保存在路由器的 ARP 表中。</p><p>路由器将使用其路由表来确定应接收数据包的下一个 IP 地址。如果路由显示目的地存在于直接连接的网络上，那么“下一个 IP 地址”就是数据包的目的地 IP 地址，也就是该数据包的最后一跳。</p><p>与路由表不同，ARP 表是按需填充的。也就是说在上图中，R1 不会向主机 B 的 MAC 地址发起 ARP 请求，直到它有一个必须传送到主机 B 的数据包。</p><p>ARP 表中记录者 IP 地址到 MAC 地址的映射，如下图所示。</p><p><img src="/courses/network/arp-table-c.png" alt="ARP 表"></p><h2 id="路由器是如何工作的" tabindex="-1"><a class="header-anchor" href="#路由器是如何工作的" aria-hidden="true">#</a> 路由器是如何工作的</h2><p>了解了路由器如何填充路由表和 ARP 表以后，我们现在来看看在网络通信中，路由器是如何工作的。</p><p>在上面 R1 的路由表中，我们可以看到有两种类型的路由：一些指向接口，另一些指向下一跳 IP 地址。我们会针对这两种类型的路由分别说明。</p><p>不过，首先我们得说明主机 A 是如何将数据包发送给路由器 R1 的。</p><h3 id="主机-a-到-r1" tabindex="-1"><a class="header-anchor" href="#主机-a-到-r1" aria-hidden="true">#</a> 主机 A 到 R1</h3><p>主机 B 和主机 C 都处于外部网络中，要与它们通信就必须将数据包先发给主机 A 的默认网关（路由器 R1）。</p><p>主机 A 会使用自己的 IP 地址 11.11.11.77 作为原 IP 地址，使用 22.22.22.88（主机 B） 或者 33.33.33.99（主机 C）作为目标地址来构建第三层数据头。要实现数据传输，主机 A 还需要知道下一跳的 MAC 地址来构建第二层数据头。</p><p>如果主机 A 已经配置了其默认网关的 IP 地址，或者主机 A 已经与外部主机通信过。那么，主机 A 很可能已经有一个带有 R1 的 MAC 地址的 ARP 表记录。但是如果这是主机 A 与外部主机的第一次通信，则在构建第二层数据头之前，主机 A 会先通过 ARP 请求获取 R1 的 MAC 地址。</p><p>当数据包到达路由器 R1 的时候，目标 IP 应该已经在 R1 的路由表中了。</p><h3 id="指向接口的路由" tabindex="-1"><a class="header-anchor" href="#指向接口的路由" aria-hidden="true">#</a> 指向接口的路由</h3><p>在路由表中，指向接口的路由通常是路由器学习获得的，因为路由器直接连接到网络。如果数据包的目标 IP 地址位于直接连接到路由器的网络中，那么路由器就知道，它们负责将数据包传送到其最后一跳。</p><p>与前面已经讨论过的相同，路由器使用第三层数据头信息来确定下一步将数据包发送到哪里，然后创建一个第二层数据头以将其发送到那里。在这个的例子中，此数据包必须经过的下一跳（也是最后一个）是到达主机 B 上的 NIC。</p><p><img src="/courses/network/route-interface-c.png" alt="指向接口的路由"></p><p>在传输的过程中，第三层的数据头不变，与主机 A 初始创建的第三层数据头相同。变化的是第二层的数据头。新的第二层数据头原 MAC 地址变成了 bb11，路由器 R1 右边接口的 MAC 地址，目标 MAC 地址变成了 bbbb，主机 B 的 MAC 地址。原始的第二层数据头被丢弃掉了。</p><h3 id="指向下一跳-ip-的路由" tabindex="-1"><a class="header-anchor" href="#指向下一跳-ip-的路由" aria-hidden="true">#</a> 指向下一跳 IP 的路由</h3><p>对于从主机 A 发送到主机 C 的数据包，目标 IP 地址将为 33.33.33.99。当 R1 查询其路由表时，它将确定 33.33.33.x 网络的下一跳位于 IP 地址 22.22.22.2，也就是 R2 的左边接口 IP 地址。</p><p>此时，路由器 R1 就会构建一个第二层数据头，将数据包发送到路由器 R2，以便继续沿途转发此数据包。由于当前“跳”在 R1 和 R2 之间，因此它们的 MAC 地址将构成源 MAC 地址和目标 MAC 地址。</p><p><img src="/courses/network/route-nexthop1-c.png" alt="指向下一跳的路由1"></p><p>第三层数据头保持不变，它包括了最初由主机 A 设置的源和目标 IP 地址，这些地址代表通信的两个“端”。第二层数据头在每一跳都完全后重新生成。</p><p>如果 R1 没有 R2 的 MAC 地址，它会简单地向路由中的 IP 地址发起 ARP 请求：22.22.22.2。之后，就可以创建正确的第二层数据头，数据包就可以从 R1 发送到 R2 了。</p><p>随着传输过程的继续，R2 将最终接收到数据包，然后像 R1 在上例中一样，将数据包传送到其最后一跳。</p><p>这个过程可以根据需要不断重复。如果主机 A 尝试与路径中隔有 10 个路由器的主机 X 通信，则主机 A 需要 10 个这样的过程来将数据正确的输出过去。在这个传输路径中，每个中转路由器都有一个路由，将主机 X 所在的网络映射到路径中的下一跳 IP。直到与主机 X 所在网络直接连接的最终路由器。这个最终路由器将负责将数据包传送到它的最后一跳，主机 X 本身。</p><h2 id="总结" tabindex="-1"><a class="header-anchor" href="#总结" aria-hidden="true">#</a> 总结</h2><p>本文对路由器是如何构建路由表和 ARP 表做了说明。</p><p>同时，借助于示例，演示了路由器是如何跨网络传输数据的。</p><div style="display:flex;align-items:center;justify-content:center;"><p style="text-align:center;margin-top:10px;color:#999;"><img src="/qrcode-c.jpg" style="width:200px;height:200px;display:block;margin:10px auto;opacity:0.8;">关注微信公众号，获取最新推送~</p><p style="text-align:center;margin-top:10px;color:#999;"><img src="/card-c.jpeg" style="width:200px;height:200px;display:block;margin:10px auto;opacity:0.8;">加微信，深入交流~</p></div><!--]--></div><footer class="page-meta"><!----><!----><!----></footer><!----><!--[--><!--]--></main></div><!----><!----><!--]--></div>
    <script src="/assets/js/runtime~app.fa50ff6a.js" defer></script><script src="/assets/js/3767.b5b9e7ce.js" defer></script><script src="/assets/js/app.8de2a662.js" defer></script>
  </body>
</html>
