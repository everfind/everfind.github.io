"use strict";(self.webpackChunkeverfind_website=self.webpackChunkeverfind_website||[]).push([[7765],{3151:(n,s,a)=>{a.r(s),a.d(s,{data:()=>p});const p={key:"v-1c26f2fc",path:"/solutions/graphql/server.html",title:"构建一个基于 GraphQL 的单体 BFF 服务",lang:"zh-CN",frontmatter:{title:"构建一个基于 GraphQL 的单体 BFF 服务",description:"介绍如何通过 GraphQL、NestJS 构建一个 BFF 服务",keywords:["BFF","GraphQL","ApolloServer","NestJS"],date:"2021-07-14T00:00:00.000Z",key:4,tags:["实践"]},excerpt:'<div style="display:flex;align-items:center;justify-content:center;"><p style="text-align: center;margin-top:10px;color:#999;"><img src="/qrcode-c.jpg" style="width:200px;height:200px;display:block;margin:10px auto;opacity:0.8;" />关注微信公众号，获取最新推送~</p><p style="text-align: center;margin-top:10px;color:#999;"><img src="/card-c.jpeg" style="width:200px;height:200px;display:block;margin:10px auto;opacity:0.8;" />加微信，深入交流~</p></div>',headers:[{level:2,title:"项目初始化",slug:"项目初始化",children:[]},{level:2,title:"添加应用代码",slug:"添加应用代码",children:[{level:3,title:"初始化 GraphQLModule",slug:"初始化-graphqlmodule",children:[]},{level:3,title:"商品模型",slug:"商品模型",children:[]},{level:3,title:"订单模型",slug:"订单模型",children:[]}]},{level:2,title:"小结",slug:"小结",children:[]}],filePathRelative:"solutions/graphql/server.md"}},9585:(n,s,a)=>{a.r(s),a.d(s,{default:()=>R});var p=a(6252);const e=(0,p.Wm)("p",null,"本文通过搭建一个简单的商品订单系统，来介绍如何基于 GraphQL、NestJS 构建一个 BFF 服务。",-1),t=(0,p.Uk)("TypeScript 这几年迅猛发展，不仅在前端开发中使用越来越广泛，在 NodeJS 端也逐步铺开。本文选择基于 TypeScript 开发的服务端框架 "),o={href:"https://nestjs.com/",target:"_blank",rel:"noopener noreferrer"},c=(0,p.Uk)("NestJS"),l=(0,p.Uk)(" 和已经被社区广泛使用的 "),r={href:"https://www.apollographql.com/",target:"_blank",rel:"noopener noreferrer"},u=(0,p.Uk)("Apollo"),i=(0,p.Uk)(" 来实现 BFF 服务。"),k=(0,p.uE)('<h2 id="项目初始化" tabindex="-1"><a class="header-anchor" href="#项目初始化" aria-hidden="true">#</a> 项目初始化</h2><p>我们直接使用 NestJS 的 CLI（命令行）工具来初始化项目，假设我们的应用名称是 <code>bff-graphql-server</code>。</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token function">yarn</span> global <span class="token function">add</span> @nestjs/cli\nnest new bff-graphql-server\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div>',3),d=(0,p.Uk)("注意，在写这篇文章的时候，NestJS 官方刚刚将 NestJS 的版本升级到 v8，一些周边的依赖包存在版本不匹配问题，因此建议使用 v7 版本，或者直接 fork demo 项目 "),b={href:"https://github.com/everfind/bff-graphql-server",target:"_blank",rel:"noopener noreferrer"},m=(0,p.Uk)("repo"),g=(0,p.Uk)("。"),v=(0,p.uE)('<p>初始化完成后，我们添加 GraphQL 依赖。</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token function">yarn</span> <span class="token function">add</span> @nestjs/graphql graphql-tools graphql apollo-server-express\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br></div></div><p>至此，我们已经完成了项目初始化。</p><h2 id="添加应用代码" tabindex="-1"><a class="header-anchor" href="#添加应用代码" aria-hidden="true">#</a> 添加应用代码</h2><p>在开始写业务代码之前，我们先规划一下目录结构。</p><p>默认初始化出来的项目目录如下：</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>-- src\n  -- main.ts // 系统启动入口\n  -- app.module.ts // 应用主模块\n  -- app.controller.ts // 控制器\n  -- app.service.ts // 服务，用于获取数据\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>我们新增加三个目录，分别是 <code>models</code>、<code>services</code>、<code>resolvers</code>：</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>-- src\n  -- modules  // 存放模型定义，最终生成 GraphQL 的 Schema\n  -- resolvers // 存放 Resolver，实现数据的聚合裁减\n  -- services // 对接后端服务接口，用于获取数据\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>在 BFF 中任何一个领域模型，都需要一份模型定义，一个获取数据的 <code>Service</code> 和一个用于数据聚合和裁减的 <code>Resolver</code>。</p><p>在这个例子中，我们需要定义两个模型，商品模型和订单模型。</p><h3 id="初始化-graphqlmodule" tabindex="-1"><a class="header-anchor" href="#初始化-graphqlmodule" aria-hidden="true">#</a> 初始化 GraphQLModule</h3><p>在 NestJS 中，我们通过 module 来管理代码，因此，我们需要初始化 <code>GraphQLModule</code>。</p><p>修改默认的 <code>src/app.module.ts</code> 代码如下：</p><div class="language-typescript ext-ts line-numbers-mode"><pre class="language-typescript"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> HttpModule<span class="token punctuation">,</span> Module <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;@nestjs/common&#39;</span><span class="token punctuation">;</span>\n<span class="token keyword">import</span> <span class="token punctuation">{</span> GqlModuleOptions<span class="token punctuation">,</span> GraphQLModule <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;@nestjs/graphql&#39;</span><span class="token punctuation">;</span>\n<span class="token keyword">import</span> <span class="token punctuation">{</span> AppController <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;./app.controller&#39;</span><span class="token punctuation">;</span>\n<span class="token keyword">import</span> resolvers <span class="token keyword">from</span> <span class="token string">&#39;./resolvers&#39;</span><span class="token punctuation">;</span>\n<span class="token keyword">import</span> services <span class="token keyword">from</span> <span class="token string">&#39;./services&#39;</span><span class="token punctuation">;</span>\n\n<span class="token decorator"><span class="token at operator">@</span><span class="token function">Module</span></span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n  imports<span class="token operator">:</span> <span class="token punctuation">[</span>\n    HttpModule<span class="token punctuation">,</span>\n    GraphQLModule<span class="token punctuation">.</span><span class="token function">forRoot</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n      debug<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token comment">// 生产环境中需要关闭</span>\n      introspection<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token comment">// 开启内省模式，生产环境中需要关闭</span>\n      path<span class="token operator">:</span> <span class="token string">&#39;/graphql&#39;</span><span class="token punctuation">,</span> <span class="token comment">// 定义 GraphQL 的请求路径</span>\n      autoSchemaFile<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token comment">// 自动生成 schema 文件</span>\n      playground<span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token comment">// UI 界面</span>\n        <span class="token comment">// 生产环境中需要关闭</span>\n        settings<span class="token operator">:</span> <span class="token punctuation">{</span>\n          <span class="token string">&#39;request.credentials&#39;</span><span class="token operator">:</span> <span class="token string">&#39;same-origin&#39;</span><span class="token punctuation">,</span>\n        <span class="token punctuation">}</span><span class="token punctuation">,</span>\n      <span class="token punctuation">}</span><span class="token punctuation">,</span>\n    <span class="token punctuation">}</span> <span class="token keyword">as</span> GqlModuleOptions<span class="token punctuation">)</span><span class="token punctuation">,</span>\n  <span class="token punctuation">]</span><span class="token punctuation">,</span>\n  controllers<span class="token operator">:</span> <span class="token punctuation">[</span>AppController<span class="token punctuation">]</span><span class="token punctuation">,</span>\n  providers<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token operator">...</span>services<span class="token punctuation">,</span> <span class="token operator">...</span>resolvers<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token comment">// 系统中定义的 service 和 resolver</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span>\n<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">AppModule</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br></div></div><h3 id="商品模型" tabindex="-1"><a class="header-anchor" href="#商品模型" aria-hidden="true">#</a> 商品模型</h3><h4 id="定义模型" tabindex="-1"><a class="header-anchor" href="#定义模型" aria-hidden="true">#</a> 定义模型</h4><p>在 <code>models</code> 目录下新建一个 <code>goods</code> 目录：</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>-- src\n  -- models\n    -- goods\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>定义商品模型，在这个模型中，商品有三个字段：</p><div class="language-typescript ext-ts line-numbers-mode"><pre class="language-typescript"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> Field<span class="token punctuation">,</span> ObjectType <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;@nestjs/graphql&#39;</span><span class="token punctuation">;</span>\n\n<span class="token decorator"><span class="token at operator">@</span><span class="token function">ObjectType</span></span><span class="token punctuation">(</span><span class="token punctuation">{</span> description<span class="token operator">:</span> <span class="token string">&#39;商品信息&#39;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>\n<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">GoodsData</span> <span class="token punctuation">{</span>\n  <span class="token decorator"><span class="token at operator">@</span><span class="token function">Field</span></span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> String<span class="token punctuation">,</span> <span class="token punctuation">{</span> nullable<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span> description<span class="token operator">:</span> <span class="token string">&#39;商品 ID&#39;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>\n  goodsId<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>\n\n  <span class="token decorator"><span class="token at operator">@</span><span class="token function">Field</span></span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> String<span class="token punctuation">,</span> <span class="token punctuation">{</span> nullable<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span> description<span class="token operator">:</span> <span class="token string">&#39;商品名称&#39;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>\n  goodsName<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>\n\n  <span class="token decorator"><span class="token at operator">@</span><span class="token function">Field</span></span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> String<span class="token punctuation">,</span> <span class="token punctuation">{</span> nullable<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> description<span class="token operator">:</span> <span class="token string">&#39;商品简介&#39;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>\n  goodsBrief<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p>现在我们定义查询商品模型的参数：</p><div class="language-typescript ext-ts line-numbers-mode"><pre class="language-typescript"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> Field<span class="token punctuation">,</span> InputType <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;@nestjs/graphql&#39;</span><span class="token punctuation">;</span>\n\n<span class="token decorator"><span class="token at operator">@</span><span class="token function">InputType</span></span><span class="token punctuation">(</span><span class="token punctuation">{</span> description<span class="token operator">:</span> <span class="token string">&#39;商品详情参数&#39;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>\n<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">GoodsParam</span> <span class="token punctuation">{</span>\n  <span class="token decorator"><span class="token at operator">@</span><span class="token function">Field</span></span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> String<span class="token punctuation">,</span> <span class="token punctuation">{</span> nullable<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span> description<span class="token operator">:</span> <span class="token string">&#39;商品 ID&#39;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>\n  goodsId<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><h4 id="定义-service" tabindex="-1"><a class="header-anchor" href="#定义-service" aria-hidden="true">#</a> 定义 Service</h4><p>在 <code>services</code> 目录下新建 <code>goods</code> 目录：</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>-- src\n  -- services\n    -- goods\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>创建一个 <code>GoodsService</code> 类：</p><div class="language-typescript ext-ts line-numbers-mode"><pre class="language-typescript"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> HttpService<span class="token punctuation">,</span> Injectable <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;@nestjs/common&#39;</span><span class="token punctuation">;</span>\n<span class="token keyword">import</span> <span class="token punctuation">{</span> GoodsData<span class="token punctuation">,</span> GoodsParam <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;src/models/goods/model&#39;</span><span class="token punctuation">;</span>\n\n<span class="token decorator"><span class="token at operator">@</span><span class="token function">Injectable</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">GoodsService</span> <span class="token punctuation">{</span>\n  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token keyword">private</span> <span class="token keyword">readonly</span> http<span class="token operator">:</span> HttpService<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>\n\n  <span class="token function">getGoods</span><span class="token punctuation">(</span>param<span class="token operator">:</span> GoodsParam<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span>GoodsData<span class="token operator">&gt;</span> <span class="token punctuation">{</span>\n    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>http\n      <span class="token punctuation">.</span><span class="token generic-function"><span class="token function">get</span><span class="token generic class-name"><span class="token operator">&lt;</span>GoodsData<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token string">&#39;/goodsservice/rest/goods/detail&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> params<span class="token operator">:</span> param <span class="token punctuation">}</span><span class="token punctuation">)</span>\n      <span class="token punctuation">.</span><span class="token function">toPromise</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n      <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span>resp<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> resp<span class="token punctuation">.</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span>\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div>',28),y=(0,p.Uk)("我们假定通过 "),h=(0,p.Wm)("code",null,"/goodsservice/rest/goods/detail",-1),f=(0,p.Uk)(" 可以查询商品详情。 "),w=(0,p.Wm)("code",null,"HttpService",-1),x=(0,p.Uk)(" 是 NestJS 提供的基于 "),G={href:"https://www.npmjs.com/package/axios",target:"_blank",rel:"noopener noreferrer"},S=(0,p.Uk)("Axios"),D=(0,p.Uk)(" 的封装。"),I=(0,p.uE)('<p>定义好 <code>GoodsService</code> 以后，我们将这个类添加到 <code>src/services/index.ts</code> 中导出。</p><div class="language-typescript ext-ts line-numbers-mode"><pre class="language-typescript"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> GoodsService <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;./goods&#39;</span><span class="token punctuation">;</span>\n\n<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">[</span>GoodsService<span class="token punctuation">]</span><span class="token punctuation">;</span>\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><h4 id="定义-resolver" tabindex="-1"><a class="header-anchor" href="#定义-resolver" aria-hidden="true">#</a> 定义 Resolver</h4><p>在 <code>resolvers</code> 目录下新建 <code>goods</code> 目录：</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>-- src\n  -- resolvers\n    -- goods\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>创建一个 <code>GoodsResolver</code> 类：</p><div class="language-typescript ext-ts line-numbers-mode"><pre class="language-typescript"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> Args<span class="token punctuation">,</span> Query<span class="token punctuation">,</span> Resolver <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;@nestjs/graphql&#39;</span><span class="token punctuation">;</span>\n<span class="token keyword">import</span> <span class="token punctuation">{</span> GoodsData<span class="token punctuation">,</span> GoodsParam <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;src/models/goods/model&#39;</span><span class="token punctuation">;</span>\n<span class="token keyword">import</span> <span class="token punctuation">{</span> GoodsService <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;src/services/goods/goods&#39;</span><span class="token punctuation">;</span>\n\n<span class="token decorator"><span class="token at operator">@</span><span class="token function">Resolver</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">GoodsResolver</span> <span class="token punctuation">{</span>\n  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token keyword">private</span> <span class="token keyword">readonly</span> goodsService<span class="token operator">:</span> GoodsService<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>\n\n  <span class="token decorator"><span class="token at operator">@</span><span class="token function">Query</span></span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> GoodsData<span class="token punctuation">,</span> <span class="token punctuation">{</span>\n    name<span class="token operator">:</span> <span class="token string">&#39;goodsData&#39;</span><span class="token punctuation">,</span>\n  <span class="token punctuation">}</span><span class="token punctuation">)</span>\n  <span class="token function">goods</span><span class="token punctuation">(</span><span class="token decorator"><span class="token at operator">@</span><span class="token function">Args</span></span><span class="token punctuation">(</span><span class="token string">&#39;param&#39;</span><span class="token punctuation">)</span> param<span class="token operator">:</span> GoodsParam<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span>GoodsData<span class="token operator">&gt;</span> <span class="token punctuation">{</span>\n    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>goodsService<span class="token punctuation">.</span><span class="token function">getGoods</span><span class="token punctuation">(</span>param<span class="token punctuation">.</span>goodsId<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span>\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><p>定义好 <code>GoodsResolver</code> 以后，我们将这个类添加到 <code>src/resolvers/index.ts</code> 中导出。</p><div class="language-typescript ext-ts line-numbers-mode"><pre class="language-typescript"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> GoodsResolver <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;./goods&#39;</span><span class="token punctuation">;</span>\n\n<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">[</span>GoodsResolver<span class="token punctuation">]</span><span class="token punctuation">;</span>\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>完成以后，启动进程，我们就可以在 playground 里面看到定义的商品模型了，如下图。</p><p><img src="/solutions/graphql/schema-c.png" alt="GraphQL Schema 图形展示"></p><p>我们在 playground 中做一些查询看看效果。</p><p><img src="/solutions/graphql/playground-c.png" alt="GraphQL playground"></p><h3 id="订单模型" tabindex="-1"><a class="header-anchor" href="#订单模型" aria-hidden="true">#</a> 订单模型</h3><p>与商品模型类似，我们需要做一些定义。</p><h4 id="定义模型-1" tabindex="-1"><a class="header-anchor" href="#定义模型-1" aria-hidden="true">#</a> 定义模型</h4><p>在 <code>models</code> 目录下新建一个 <code>orders</code> 目录：</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>-- src\n  -- models\n    -- orders\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>定义订单模型和查询参数，如下：</p><div class="language-typescript ext-ts line-numbers-mode"><pre class="language-typescript"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> Field<span class="token punctuation">,</span> Float<span class="token punctuation">,</span> InputType<span class="token punctuation">,</span> ObjectType <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;@nestjs/graphql&#39;</span><span class="token punctuation">;</span>\n\n<span class="token decorator"><span class="token at operator">@</span><span class="token function">ObjectType</span></span><span class="token punctuation">(</span><span class="token punctuation">{</span> description<span class="token operator">:</span> <span class="token string">&#39;订单数据&#39;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>\n<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">OrderData</span> <span class="token punctuation">{</span>\n  <span class="token decorator"><span class="token at operator">@</span><span class="token function">Field</span></span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> String<span class="token punctuation">,</span> <span class="token punctuation">{</span> nullable<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span> description<span class="token operator">:</span> <span class="token string">&#39;订单号&#39;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>\n  orderNo<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>\n\n  <span class="token decorator"><span class="token at operator">@</span><span class="token function">Field</span></span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> String<span class="token punctuation">,</span> <span class="token punctuation">{</span> nullable<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span> description<span class="token operator">:</span> <span class="token string">&#39;商品 ID&#39;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>\n  goodsId<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>\n\n  <span class="token decorator"><span class="token at operator">@</span><span class="token function">Field</span></span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> Float<span class="token punctuation">,</span> <span class="token punctuation">{</span> nullable<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span> description<span class="token operator">:</span> <span class="token string">&#39;金额&#39;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>\n  pay<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">;</span>\n\n  <span class="token decorator"><span class="token at operator">@</span><span class="token function">Field</span></span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> String<span class="token punctuation">,</span> <span class="token punctuation">{</span> nullable<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> description<span class="token operator">:</span> <span class="token string">&#39;备注信息&#39;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>\n  comment<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n\n<span class="token decorator"><span class="token at operator">@</span><span class="token function">InputType</span></span><span class="token punctuation">(</span><span class="token punctuation">{</span> description<span class="token operator">:</span> <span class="token string">&#39;订单详情参数&#39;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>\n<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">OrderParam</span> <span class="token punctuation">{</span>\n  <span class="token decorator"><span class="token at operator">@</span><span class="token function">Field</span></span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> String<span class="token punctuation">,</span> <span class="token punctuation">{</span> nullable<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span> description<span class="token operator">:</span> <span class="token string">&#39;订单号&#39;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>\n  orderNo<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br></div></div><p>需要注意的是，<code>OrderData</code> 中有一个 <code>goodsId</code> 字段与商品建立关系，我们后面在 <code>Resolver</code> 中需要借助于这个字段来查询商品信息。</p><h4 id="定义-service-1" tabindex="-1"><a class="header-anchor" href="#定义-service-1" aria-hidden="true">#</a> 定义 Service</h4><p>在 <code>services</code> 目录下新建 <code>orders</code> 目录：</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>-- src\n  -- services\n    -- orders\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>创建一个 <code>OrderService</code> 类：</p><div class="language-typescript ext-ts line-numbers-mode"><pre class="language-typescript"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> HttpService<span class="token punctuation">,</span> Injectable <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;@nestjs/common&#39;</span><span class="token punctuation">;</span>\n<span class="token keyword">import</span> <span class="token punctuation">{</span> OrderData<span class="token punctuation">,</span> OrderParam <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;src/models/orders/model&#39;</span><span class="token punctuation">;</span>\n\n<span class="token decorator"><span class="token at operator">@</span><span class="token function">Injectable</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">OrderService</span> <span class="token punctuation">{</span>\n  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token keyword">private</span> <span class="token keyword">readonly</span> http<span class="token operator">:</span> HttpService<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>\n\n  <span class="token function">getOrder</span><span class="token punctuation">(</span>param<span class="token operator">:</span> OrderParam<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span>OrderData<span class="token operator">&gt;</span> <span class="token punctuation">{</span>\n    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>http\n      <span class="token punctuation">.</span><span class="token generic-function"><span class="token function">get</span><span class="token generic class-name"><span class="token operator">&lt;</span>OrderData<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token string">&#39;/goodsservice/rest/order/detail&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> params<span class="token operator">:</span> param <span class="token punctuation">}</span><span class="token punctuation">)</span>\n      <span class="token punctuation">.</span><span class="token function">toPromise</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n      <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span>resp<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> resp<span class="token punctuation">.</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span>\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><blockquote><p>别忘了在 <code>src/services/index.ts</code> 添加 <code>OrderService</code> 的导出。</p></blockquote><h4 id="定义-resolver-1" tabindex="-1"><a class="header-anchor" href="#定义-resolver-1" aria-hidden="true">#</a> 定义 Resolver</h4><p>在 <code>resolvers</code> 目录下新建 <code>orders</code> 目录：</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>-- src\n  -- resolvers\n    -- orders\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>创建一个 <code>OrderResolver</code> 类：</p><div class="language-typescript ext-ts line-numbers-mode"><pre class="language-typescript"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> Args<span class="token punctuation">,</span> Query<span class="token punctuation">,</span> Resolver <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;@nestjs/graphql&#39;</span><span class="token punctuation">;</span>\n<span class="token keyword">import</span> <span class="token punctuation">{</span> OrderData OrderParam <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;src/models/orders/model&#39;</span><span class="token punctuation">;</span>\n<span class="token keyword">import</span> <span class="token punctuation">{</span> OrderService <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;src/services/orders/order&#39;</span><span class="token punctuation">;</span>\n\n<span class="token decorator"><span class="token at operator">@</span><span class="token function">Resolver</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">OrderResolver</span> <span class="token punctuation">{</span>\n  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token keyword">private</span> <span class="token keyword">readonly</span> orderService<span class="token operator">:</span> OrderService<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>\n\n  <span class="token decorator"><span class="token at operator">@</span><span class="token function">Query</span></span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> OrderData<span class="token punctuation">,</span> <span class="token punctuation">{</span>\n    name<span class="token operator">:</span> <span class="token string">&#39;orderData&#39;</span><span class="token punctuation">,</span>\n  <span class="token punctuation">}</span><span class="token punctuation">)</span>\n  <span class="token function">order</span><span class="token punctuation">(</span><span class="token decorator"><span class="token at operator">@</span><span class="token function">Args</span></span><span class="token punctuation">(</span><span class="token string">&#39;param&#39;</span><span class="token punctuation">)</span> param<span class="token operator">:</span> OrderParam<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span>OrderData<span class="token operator">&gt;</span> <span class="token punctuation">{</span>\n    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>orderService<span class="token punctuation">.</span><span class="token function">getOrder</span><span class="token punctuation">(</span>param<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span>\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><blockquote><p>注意，别忘了在 <code>src/resolvers/index.ts</code> 中添加 <code>OrderResolver</code> 的导出。</p></blockquote><p>定义好 <code>OrderResolver</code> 以后，我们就可以查询订单信息。</p><p>这时候，如果我们直接查询订单上的商品信息是查不到，因为还没建立相关的 Resolver。</p><p>我们现在添加一个 <code>OrderPropertyResolver</code> 类：</p><div class="language-typescript ext-ts line-numbers-mode"><pre class="language-typescript"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> Args<span class="token punctuation">,</span> Parent<span class="token punctuation">,</span> Query<span class="token punctuation">,</span> ResolveField<span class="token punctuation">,</span> Resolver <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;@nestjs/graphql&#39;</span><span class="token punctuation">;</span>\n<span class="token keyword">import</span> <span class="token punctuation">{</span> GoodsData <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;src/models/goods/model&#39;</span><span class="token punctuation">;</span>\n<span class="token keyword">import</span> <span class="token punctuation">{</span> OrderData <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;src/models/orders/model&#39;</span><span class="token punctuation">;</span>\n<span class="token keyword">import</span> <span class="token punctuation">{</span> GoodsService <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;src/services/goods/goods&#39;</span><span class="token punctuation">;</span>\n\n<span class="token decorator"><span class="token at operator">@</span><span class="token function">Resolver</span></span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> OrderData<span class="token punctuation">)</span>\n<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">OrderPropertyResolver</span> <span class="token punctuation">{</span>\n  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token keyword">private</span> <span class="token keyword">readonly</span> goodsService<span class="token operator">:</span> GoodsService<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>\n\n  <span class="token decorator"><span class="token at operator">@</span><span class="token function">ResolveField</span></span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> GoodsData<span class="token punctuation">,</span> <span class="token punctuation">{</span>\n    name<span class="token operator">:</span> <span class="token string">&#39;goodsData&#39;</span><span class="token punctuation">,</span>\n    nullable<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>\n  <span class="token punctuation">}</span><span class="token punctuation">)</span>\n  <span class="token function">goodsData</span><span class="token punctuation">(</span><span class="token decorator"><span class="token at operator">@</span><span class="token function">Parent</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> orderData<span class="token operator">:</span> OrderData<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span>GoodsData<span class="token operator">&gt;</span> <span class="token punctuation">{</span>\n    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>goodsService<span class="token punctuation">.</span><span class="token function">getGoodsById</span><span class="token punctuation">(</span>orderData<span class="token punctuation">.</span>goodsId<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span>\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><p>注意这里 <code>@Resolver(() =&gt; OrderData)</code> 的写法，它告诉 GraphQL，当需要解析 <code>OrderData</code> 上的字段信息时，使用这个 Resolver 类。</p><p>我们通过 <code>@Parent()</code> 装饰器可以拿到 <code>OrderData</code> 上的数据，在这个例子中就是 <code>goodsId</code>。</p><p>这里要额外说一点，通常来说，单个订单直接通过商品详情接口查商品数据没有问题，但是如果是订单列表要查商品数据，依然通过商品详情接口查的话就会产生 N + 1 问题了。</p>',40),L=(0,p.Uk)("在前面的文章中我们提到过，可以借助于 "),O={href:"https://npmjs.org/package/dataloader",target:"_blank",rel:"noopener noreferrer"},q=(0,p.Uk)("DataLoader"),F=(0,p.Uk)(" 来解决 N + 1 问题。"),j=(0,p.uE)('<p>我们对 <code>GoodsService</code> 做一些改造，引入 DataLoader。</p><div class="language-typescript ext-ts line-numbers-mode"><pre class="language-typescript"><code><span class="token keyword">import</span> DataLoader <span class="token keyword">from</span> <span class="token string">&#39;dataloader&#39;</span><span class="token punctuation">;</span>\n\n<span class="token decorator"><span class="token at operator">@</span><span class="token function">Injectable</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">GoodsService</span> <span class="token punctuation">{</span>\n  <span class="token comment">// 其他代码</span>\n\n  <span class="token keyword">private</span> goodsLoader <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DataLoader<span class="token operator">&lt;</span><span class="token builtin">string</span><span class="token punctuation">,</span> GoodsData<span class="token operator">&gt;</span></span><span class="token punctuation">(</span>\n    <span class="token keyword">async</span> <span class="token punctuation">(</span>goodsIdList<span class="token operator">:</span> <span class="token keyword">readonly</span> <span class="token builtin">string</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>\n      <span class="token keyword">const</span> goodsList <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">batchGetGoodsByGoodsId</span><span class="token punctuation">(</span>\n        goodsIdList <span class="token keyword">as</span> <span class="token builtin">string</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>\n      <span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token keyword">return</span> goodsIdList<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span>goodsId<span class="token punctuation">)</span> <span class="token operator">=&gt;</span>\n        goodsList<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">(</span>goodsData<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> goodsData<span class="token punctuation">.</span>goodsId <span class="token operator">===</span> goodsId<span class="token punctuation">)</span><span class="token punctuation">,</span>\n      <span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span><span class="token punctuation">,</span>\n  <span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token keyword">private</span> <span class="token function">batchGetGoodsByGoodsId</span><span class="token punctuation">(</span>goodsIdList<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span>GoodsData<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>\n    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>http\n      <span class="token punctuation">.</span><span class="token generic-function"><span class="token function">get</span><span class="token generic class-name"><span class="token operator">&lt;</span>GoodsData<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token string">&#39;/goodsservice/rest/goods/list-by-id&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>\n        params<span class="token operator">:</span> goodsIdList<span class="token punctuation">,</span>\n      <span class="token punctuation">}</span><span class="token punctuation">)</span>\n      <span class="token punctuation">.</span><span class="token function">toPromise</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n      <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span>resp<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>\n        <span class="token keyword">return</span> resp<span class="token punctuation">.</span>data<span class="token punctuation">;</span>\n      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n\n  <span class="token function">getGoodsById</span><span class="token punctuation">(</span>goodsId<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span>GoodsData<span class="token operator">&gt;</span> <span class="token punctuation">{</span>\n    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>goodsLoader<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span>goodsId<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n\n  <span class="token function">getGoodsByIdList</span><span class="token punctuation">(</span>goodsIdList<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span><span class="token punctuation">(</span>GoodsData <span class="token operator">|</span> Error<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>\n    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>goodsLoader<span class="token punctuation">.</span><span class="token function">loadMany</span><span class="token punctuation">(</span>goodsIdList<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span>\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br></div></div><blockquote><p>正如代码中所示，DataLoader 依赖后端提供一个批量接口，即通过 <code>goodsId</code> 批量查询 <code>GoodsData</code> 信息。</p></blockquote><p>完成以后，我们就可以愉快的在查询订单的时候也查询商品信息了。</p><p><img src="/solutions/graphql/order-demo-c.png" alt="查询订单信息"></p><h2 id="小结" tabindex="-1"><a class="header-anchor" href="#小结" aria-hidden="true">#</a> 小结</h2><p>我们通过搭建一个简单的订单、商品系统展示了如果开发一个基于 GraphQL 的 BFF 服务。</p><p>结合 NestJS 和 Apollo，我们可以方便的通过 TypeScript 来开发 GraphQL 服务，极大的提升开发效率。</p><p>借助于 GraphQL 的 playground，我们可以方便的对系统进行查询，不依赖前端代码实现。</p><div style="display:flex;align-items:center;justify-content:center;"><p style="text-align:center;margin-top:10px;color:#999;"><img src="/qrcode-c.jpg" style="width:200px;height:200px;display:block;margin:10px auto;opacity:0.8;">关注微信公众号，获取最新推送~</p><p style="text-align:center;margin-top:10px;color:#999;"><img src="/card-c.jpeg" style="width:200px;height:200px;display:block;margin:10px auto;opacity:0.8;">加微信，深入交流~</p></div>',10),R={render:function(n,s){const a=(0,p.up)("OutboundLink");return(0,p.wg)(),(0,p.j4)(p.HY,null,[e,(0,p.Wm)("p",null,[t,(0,p.Wm)("a",o,[c,(0,p.Wm)(a)]),l,(0,p.Wm)("a",r,[u,(0,p.Wm)(a)]),i]),k,(0,p.Wm)("blockquote",null,[(0,p.Wm)("p",null,[d,(0,p.Wm)("a",b,[m,(0,p.Wm)(a)]),g])]),v,(0,p.Wm)("blockquote",null,[(0,p.Wm)("p",null,[y,h,f,w,x,(0,p.Wm)("a",G,[S,(0,p.Wm)(a)]),D])]),I,(0,p.Wm)("p",null,[L,(0,p.Wm)("a",O,[q,(0,p.Wm)(a)]),F]),j],64)}}}}]);