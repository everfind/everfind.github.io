<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <link rel="icon" href="/favicon.ico"><link rel="manifest" href="/manifest.webmanifest"><meta name="theme-color" content="#5397d2"><script>
      var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?e772d8d7735057378a672ae311e9bf20";
  var s = document.getElementsByTagName("script")[0];
  s.parentNode.insertBefore(hm, s);
})();
    </script><title>网页里的“选中复制”到底选了个啥？ | 众里千寻</title><meta name="description" content="介绍用户选中相关的规范定义，并结合 deeplink 库说明在实际中的使用。"><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><meta name="generator" content="VuePress 2.0.0-beta.22">
    <link rel="preload" href="/assets/js/runtime~app.fa50ff6a.js" as="script"><link rel="preload" href="/assets/css/styles.e0095a00.css" as="style"><link rel="preload" href="/assets/js/3767.b5b9e7ce.js" as="script"><link rel="preload" href="/assets/js/app.8de2a662.js" as="script">
    <link rel="stylesheet" href="/assets/css/styles.e0095a00.css">
  </head>
  <body>
    <div id="app"><!--[--><div class="theme-container"><header class="navbar"><div class="toggle-sidebar-button"><svg class="icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div><span><a href="/" class=""><img class="logo" src="/hero-c.png" alt="众里千寻"><span class="site-name can-hide">众里千寻</span></a></span><div class="navbar-links-wrapper" style=""><!--[--><!--]--><nav class="navbar-links can-hide"><!--[--><div class="navbar-links-item"><a href="/courses/" class="nav-link" aria-label="学习笔记"><!--[--><!--]--> 学习笔记 <!--[--><!--]--></a></div><div class="navbar-links-item"><a href="/solutions/" class="nav-link" aria-label="解决方案"><!--[--><!--]--> 解决方案 <!--[--><!--]--></a></div><div class="navbar-links-item"><a href="/tools/" class="nav-link" aria-label="开发利器"><!--[--><!--]--> 开发利器 <!--[--><!--]--></a></div><div class="navbar-links-item"><a href="/code-reading/" class="nav-link" aria-label="源码解读"><!--[--><!--]--> 源码解读 <!--[--><!--]--></a></div><div class="navbar-links-item"><a href="/posts/" class="nav-link router-link-active" aria-label="最新消息"><!--[--><!--]--> 最新消息 <!--[--><!--]--></a></div><div class="navbar-links-item"><a class="nav-link external" href="https://github.com/everfind" rel="noopener noreferrer" target="_blank" aria-label="GitHub"><!--[--><!--]--> GitHub <span><svg class="icon outbound" xmlns="http://www.w3.org/2000/svg" ariahidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><!--[--><span class="sr-only">open in new window</span><!--]--></span><!--[--><!--]--></a></div><!--]--></nav><!--[--><!--]--><button class="toggle-dark-button"><svg style="" class="icon" focusable="false" viewBox="0 0 32 32"><path d="M16 12.005a4 4 0 1 1-4 4a4.005 4.005 0 0 1 4-4m0-2a6 6 0 1 0 6 6a6 6 0 0 0-6-6z" fill="currentColor"></path><path d="M5.394 6.813l1.414-1.415l3.506 3.506L8.9 10.318z" fill="currentColor"></path><path d="M2 15.005h5v2H2z" fill="currentColor"></path><path d="M5.394 25.197L8.9 21.691l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 25.005h2v5h-2z" fill="currentColor"></path><path d="M21.687 23.106l1.414-1.415l3.506 3.506l-1.414 1.414z" fill="currentColor"></path><path d="M25 15.005h5v2h-5z" fill="currentColor"></path><path d="M21.687 8.904l3.506-3.506l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 2.005h2v5h-2z" fill="currentColor"></path></svg><svg style="display:none;" class="icon" focusable="false" viewBox="0 0 32 32"><path d="M13.502 5.414a15.075 15.075 0 0 0 11.594 18.194a11.113 11.113 0 0 1-7.975 3.39c-.138 0-.278.005-.418 0a11.094 11.094 0 0 1-3.2-21.584M14.98 3a1.002 1.002 0 0 0-.175.016a13.096 13.096 0 0 0 1.825 25.981c.164.006.328 0 .49 0a13.072 13.072 0 0 0 10.703-5.555a1.01 1.01 0 0 0-.783-1.565A13.08 13.08 0 0 1 15.89 4.38A1.015 1.015 0 0 0 14.98 3z" fill="currentColor"></path></svg></button><form class="search-box" role="search"><input type="search" autocomplete="off" spellcheck="false" value><!----></form></div></header><div class="sidebar-mask"></div><aside class="sidebar"><nav class="navbar-links"><!--[--><div class="navbar-links-item"><a href="/courses/" class="nav-link" aria-label="学习笔记"><!--[--><!--]--> 学习笔记 <!--[--><!--]--></a></div><div class="navbar-links-item"><a href="/solutions/" class="nav-link" aria-label="解决方案"><!--[--><!--]--> 解决方案 <!--[--><!--]--></a></div><div class="navbar-links-item"><a href="/tools/" class="nav-link" aria-label="开发利器"><!--[--><!--]--> 开发利器 <!--[--><!--]--></a></div><div class="navbar-links-item"><a href="/code-reading/" class="nav-link" aria-label="源码解读"><!--[--><!--]--> 源码解读 <!--[--><!--]--></a></div><div class="navbar-links-item"><a href="/posts/" class="nav-link router-link-active" aria-label="最新消息"><!--[--><!--]--> 最新消息 <!--[--><!--]--></a></div><div class="navbar-links-item"><a class="nav-link external" href="https://github.com/everfind" rel="noopener noreferrer" target="_blank" aria-label="GitHub"><!--[--><!--]--> GitHub <span><svg class="icon outbound" xmlns="http://www.w3.org/2000/svg" ariahidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><!--[--><span class="sr-only">open in new window</span><!--]--></span><!--[--><!--]--></a></div><!--]--></nav><!--[--><!--]--><ul class="sidebar-links"><!--[--><!--[--><p class="sidebar-heading sidebar-item">网页里的“选中复制”到底选了个啥？</p><ul class=""><li><!--[--><a aria-current="page" href="/posts/2022/01/28/web-selection.html#如何定义选中的范围" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="如何定义选中的范围"><!--[--><!--]--> 如何定义选中的范围 <!--[--><!--]--></a><ul class="sidebar-sub-items"><li><!--[--><a aria-current="page" href="/posts/2022/01/28/web-selection.html#边界点" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="边界点"><!--[--><!--]--> 边界点 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a aria-current="page" href="/posts/2022/01/28/web-selection.html#范围" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="范围"><!--[--><!--]--> 范围 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a aria-current="page" href="/posts/2022/01/28/web-selection.html#选中" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="选中"><!--[--><!--]--> 选中 <!--[--><!--]--></a><!----><!--]--></li></ul><!--]--></li><li><!--[--><a aria-current="page" href="/posts/2022/01/28/web-selection.html#deeplinks-中的使用" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="deeplinks 中的使用"><!--[--><!--]--> deeplinks 中的使用 <!--[--><!--]--></a><!----><!--]--></li></ul><!--]--><!--]--></ul><!--[--><!--]--></aside><main class="page"><!--[--><!--]--><div class="theme-default-content"><!--[--><p>当我们在网页中选中某一段内容的时候，浏览器会添加选中效果来标识选中的范围。我们可以从左到右选，也可以从右到左选。我们可以选择文字，也可以选择图片，或者选择图片加文字。浏览器是如何处理我们的选中操作的呢？</p><p>我最近在处理一个网页选中的问题，顺便研究了一下规范中是如何定义选中的，发现还是蛮有趣的，分享一下。</p><h2 id="如何定义选中的范围" tabindex="-1"><a class="header-anchor" href="#如何定义选中的范围" aria-hidden="true">#</a> 如何定义选中的范围</h2><p>不管是从左到右，还是从右到左，又或者是单单选择一个字，我们都选中了一个范围。范围由两个边界点构成。</p><h3 id="边界点" tabindex="-1"><a class="header-anchor" href="#边界点" aria-hidden="true">#</a> 边界点</h3><p>规范中是这么定义边界点（boundary point）的：</p><blockquote><p>A <a href="https://dom.spec.whatwg.org/#boundary-points" target="_blank" rel="noopener noreferrer">boundary point<span><svg class="icon outbound" xmlns="http://www.w3.org/2000/svg" ariahidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><!--[--><span class="sr-only">open in new window</span><!--]--></span></a> is a tuple consisting of a node (a node) and an offset (a non-negative integer).</p></blockquote><p>边界点由两部分组成，一个是边界点所在节点（node），另一个是边界点在节点中的偏移量。</p><div class="language-html ext-html line-numbers-mode"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">&gt;</span></span>Hello, everfind!<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br></div></div><p>举个例子，上面的文本中，如果我们选择了 <code>everfind</code> 这段，那么边界点就是 <code>(p, 7)</code> 和 <code>(p, 15)</code>。</p><p>边界点之间有三种位置关系：前面、相等和后面。具体的<a href="https://dom.spec.whatwg.org/#concept-range-bp-position" target="_blank" rel="noopener noreferrer">位置计算方法<span><svg class="icon outbound" xmlns="http://www.w3.org/2000/svg" ariahidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><!--[--><span class="sr-only">open in new window</span><!--]--></span></a>可以参考规范定义。</p><h3 id="范围" tabindex="-1"><a class="header-anchor" href="#范围" aria-hidden="true">#</a> 范围</h3><p>范围（<a href="https://dom.spec.whatwg.org/#ranges" target="_blank" rel="noopener noreferrer">range<span><svg class="icon outbound" xmlns="http://www.w3.org/2000/svg" ariahidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><!--[--><span class="sr-only">open in new window</span><!--]--></span></a>）由两个边界点来定义，两个边界点被称为开始（start）节点和结束（end）节点。</p><p><img src="/posts/images/web-selection/node-tree-c.png" alt="range 样例"></p><p>上图展示了一段 DOM 结构，如果我们选中了 <code>syndata is awes</code> 这段文字，那么范围可以表示如下：</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> range <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Range</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> firstText <span class="token operator">=</span> p<span class="token punctuation">.</span>childNodes<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// 假设 p 指向 P 元素</span>
<span class="token keyword">const</span> secondText <span class="token operator">=</span> em<span class="token punctuation">.</span>firstChild<span class="token punctuation">;</span> <span class="token comment">// 假设 em 指向 EM 元素</span>
range<span class="token punctuation">.</span><span class="token function">setStart</span><span class="token punctuation">(</span>firstText<span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 前面有一个空格</span>
range<span class="token punctuation">.</span><span class="token function">setEnd</span><span class="token punctuation">(</span>secondText<span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>注意，在一个范围中，开始节点不能在结束节点的后面。如果开始节点与结束节点相等，则认为范围是折叠的（collapsed）。如果开始节点在结束节点后面，则范围会被强制置为折叠的。</p><p>在上面的样例中，我们使用了 <code>Range</code> 类，其实还有一个 <code>StaticRange</code> 类。<code>Range</code> 定义的范围会随着节点树的变化而变化，比如用户节点改变了节点树中的内容，那么通过 <code>Range</code> 定义的范围内容也会随着变化。而 <code>StaticRange</code> 定义的范围比较轻量，不会随着节点树的变化而变化。</p><h3 id="选中" tabindex="-1"><a class="header-anchor" href="#选中" aria-hidden="true">#</a> 选中</h3><p>定义清楚“范围”以后，就能够定义“选中”这个概念了。在<a href="https://w3c.github.io/selection-api/" target="_blank" rel="noopener noreferrer">关于“选中”的规范<span><svg class="icon outbound" xmlns="http://www.w3.org/2000/svg" ariahidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><!--[--><span class="sr-only">open in new window</span><!--]--></span></a>中，规范要求，“选中”是一个单例对象，且只能与一个“范围”对象关联。如果“选中”没有与任何“范围”对象关联，那么“选中”就是空的（empty）。“选中”在初始状态下都是空的。</p><div class="language-typescript ext-ts line-numbers-mode"><pre class="language-typescript"><code><span class="token keyword">interface</span> <span class="token class-name">Selection</span> <span class="token punctuation">{</span>
  <span class="token keyword">readonly</span> attribute Node<span class="token operator">?</span> anchorNode<span class="token punctuation">;</span>
  <span class="token keyword">readonly</span> attribute unsigned long anchorOffset<span class="token punctuation">;</span>
  <span class="token keyword">readonly</span> attribute Node<span class="token operator">?</span> focusNode<span class="token punctuation">;</span>
  <span class="token keyword">readonly</span> attribute unsigned long focusOffset<span class="token punctuation">;</span>
  <span class="token keyword">readonly</span> attribute <span class="token builtin">boolean</span> isCollapsed<span class="token punctuation">;</span>
  <span class="token keyword">readonly</span> attribute unsigned long rangeCount<span class="token punctuation">;</span>
  <span class="token keyword">readonly</span> attribute DOMString type<span class="token punctuation">;</span>
  Range <span class="token function">getRangeAt</span><span class="token punctuation">(</span>unsigned long index<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">undefined</span> <span class="token function">addRange</span><span class="token punctuation">(</span>Range range<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">undefined</span> <span class="token function">removeRange</span><span class="token punctuation">(</span>Range range<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">undefined</span> <span class="token function">removeAllRanges</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token operator">...</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p>上面摘录了一些 <a href="https://w3c.github.io/selection-api/#selection-interface" target="_blank" rel="noopener noreferrer"><code>Selection</code> 接口<span><svg class="icon outbound" xmlns="http://www.w3.org/2000/svg" ariahidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><!--[--><span class="sr-only">open in new window</span><!--]--></span></a> 的字段说明，我们可以看到，Selection 对象中并不是直接保存 <code>Range</code> 对象，而是通过 <code>anchorNode</code>、<code>anchorOffset</code>、<code>focusNode</code>、<code>focusOffset</code> 来标识选中的范围。</p><p>我们知道，用户选择是有方向的，而 <code>Range</code> 中的开始节点与结束节点是严格按照 DOM 顺序的，因此 <code>Selection</code> 做了变通。<code>anchorNode</code> 是用户开始选择的位置，<code>focusNode</code> 是用户结束选择的位置。如果您使用桌面鼠标进行选择，则 <code>anchorNode</code> 放置在您按下鼠标按钮的位置，<code>focusNode</code> 放置在您释放鼠标按钮的位置。千万不要将 <code>anchorNode</code>、<code>focusNode</code> 与 <code>Range</code> 的开始节点、结束节点相混淆。</p><blockquote><p>我们看到，在 <code>Selection</code> 接口中定义了一些 <code>Range</code> 操作函数，看着像是可以有多个 <code>Range</code>。其实 <code>Selection</code> API 最初由 Netscape 创建并允许多个范围（例如，允许用户从 <code>&lt;table&gt;</code> 中选择一列）。但是，Gecko 以外的浏览器并没有实现多个范围。规范最终要求 <code>Selection</code> 始终具有单个 <code>Range</code>。</p></blockquote><p>在浏览器中，我们可以通过 <code>document.getSelection()</code> 和 <code>window.getSelection()</code> 来获取选中的内容，这两个 API 是相等的。通过 <code>Selection</code> 接口中定义的操作函数，我们可以动态需改选中的内容。</p><h2 id="deeplinks-中的使用" tabindex="-1"><a class="header-anchor" href="#deeplinks-中的使用" aria-hidden="true">#</a> deeplinks 中的使用</h2><p><a href="https://github.com/WesleyAC/deeplinks" target="_blank" rel="noopener noreferrer">deeplinks<span><svg class="icon outbound" xmlns="http://www.w3.org/2000/svg" ariahidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><!--[--><span class="sr-only">open in new window</span><!--]--></span></a> 是一个选中内容分享工具。它通过 <code>Selection</code> API，将用户选中的文本计算出一个 hash 值，然后将这个 hash 值放到 URL 中的 fragment 部分。用户打开这个新的 URL 时，deeplinks 会通过 fragment 计算出选中的范围，通过 <code>Selection</code> API 高亮选中的文字。</p><p>在其核心 API <a href="https://github.com/WesleyAC/deeplinks/blob/main/src/versions/2.ts#L104" target="_blank" rel="noopener noreferrer"><code>selectionToFragment</code><span><svg class="icon outbound" xmlns="http://www.w3.org/2000/svg" ariahidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><!--[--><span class="sr-only">open in new window</span><!--]--></span></a> 函数中，</p><div class="language-typescript ext-ts line-numbers-mode"><pre class="language-typescript"><code><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">selectionToFragment</span><span class="token punctuation">(</span>selection<span class="token operator">:</span> Selection<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">string</span> <span class="token punctuation">{</span>
  <span class="token keyword">type</span> <span class="token class-name">HashNodeOffset</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">,</span> Text<span class="token punctuation">,</span> <span class="token builtin">string</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword">type</span> <span class="token class-name">DupeData</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token builtin">boolean</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token builtin">number</span><span class="token punctuation">,</span> <span class="token builtin">number</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> ranges<span class="token operator">:</span> <span class="token punctuation">[</span>HashNodeOffset<span class="token punctuation">,</span> HashNodeOffset<span class="token punctuation">,</span> DupeData<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> selection<span class="token punctuation">.</span>rangeCount<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> range <span class="token operator">=</span> <span class="token function">normalizeRange</span><span class="token punctuation">(</span>selection<span class="token punctuation">.</span><span class="token function">getRangeAt</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// normalizeRange 去除非 Text 节点</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>range <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>range<span class="token punctuation">.</span>collapsed<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> <span class="token punctuation">[</span>startNode<span class="token punctuation">,</span> endNode<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span>range<span class="token punctuation">.</span>startContainer<span class="token punctuation">,</span> range<span class="token punctuation">.</span>endContainer<span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>startNode<span class="token punctuation">.</span>nodeType <span class="token operator">==</span> <span class="token constant">TEXT_NODE</span> <span class="token operator">&amp;&amp;</span> endNode<span class="token punctuation">.</span>nodeType <span class="token operator">==</span> <span class="token constant">TEXT_NODE</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        ranges<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
          <span class="token punctuation">[</span><span class="token function">hashNode</span><span class="token punctuation">(</span>startNode <span class="token keyword">as</span> Text<span class="token punctuation">)</span><span class="token punctuation">,</span> startNode <span class="token keyword">as</span> Text<span class="token punctuation">,</span> <span class="token function">fromNumber</span><span class="token punctuation">(</span>Math<span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span>range<span class="token punctuation">.</span>startOffset <span class="token operator">-</span> <span class="token function">countLeadingWhitespace</span><span class="token punctuation">(</span>startNode <span class="token keyword">as</span> Text<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
          <span class="token punctuation">[</span><span class="token function">hashNode</span><span class="token punctuation">(</span>endNode <span class="token keyword">as</span> Text<span class="token punctuation">)</span><span class="token punctuation">,</span> endNode <span class="token keyword">as</span> Text<span class="token punctuation">,</span> <span class="token function">fromNumber</span><span class="token punctuation">(</span>Math<span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span>Math<span class="token punctuation">.</span><span class="token function">min</span><span class="token punctuation">(</span>range<span class="token punctuation">.</span>endOffset <span class="token operator">-</span> <span class="token function">countLeadingWhitespace</span><span class="token punctuation">(</span>endNode <span class="token keyword">as</span> Text<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>endNode <span class="token keyword">as</span> Text<span class="token punctuation">)</span><span class="token punctuation">.</span>wholeText<span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
          <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token operator">...</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><p>我们可以看到，通过 <code>selection.getRangeAt(i)</code> 获取当前选中范围，然后通过一些操作过滤掉非 Text 节点，拿到只包含文本的新的 <code>Range</code>。之后经过一些计算，标记出用户选中的真实范围。</p><blockquote><p>由于 deeplinks 本身实现逻辑较为复杂，与本篇主题有一些偏离，这里没有详细说明，感兴趣的同学可以自行阅读源码。</p></blockquote><div style="display:flex;align-items:center;justify-content:center;"><p style="text-align:center;margin-top:10px;color:#999;"><img src="/qrcode-c.jpg" style="width:200px;height:200px;display:block;margin:10px auto;opacity:0.8;">关注微信公众号，获取最新推送~</p><p style="text-align:center;margin-top:10px;color:#999;"><img src="/card-c.jpeg" style="width:200px;height:200px;display:block;margin:10px auto;opacity:0.8;">加微信，深入交流~</p></div><!--]--></div><footer class="page-meta"><!----><!----><!----></footer><!----><!--[--><!--]--></main></div><!----><!----><!--]--></div>
    <script src="/assets/js/runtime~app.fa50ff6a.js" defer></script><script src="/assets/js/3767.b5b9e7ce.js" defer></script><script src="/assets/js/app.8de2a662.js" defer></script>
  </body>
</html>
