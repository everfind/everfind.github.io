<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <link rel="icon" href="/favicon.ico"><link rel="manifest" href="/manifest.webmanifest"><meta name="theme-color" content="#5397d2"><script>
      var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?e772d8d7735057378a672ae311e9bf20";
  var s = document.getElementsByTagName("script")[0];
  s.parentNode.insertBefore(hm, s);
})();
    </script><title>Schema 合成管理系统 | 众里千寻</title><meta name="description" content="采用 Apollo Federation 以后，需要对子服务的 Schema 做合成和管理，以及一些工程问题需要解决。我们通过一个独立的 Schema 合成管理系统来解决。"><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><meta name="generator" content="VuePress 2.0.0-beta.22">
    <link rel="preload" href="/assets/js/runtime~app.fa50ff6a.js" as="script"><link rel="preload" href="/assets/css/styles.e0095a00.css" as="style"><link rel="preload" href="/assets/js/3767.b5b9e7ce.js" as="script"><link rel="preload" href="/assets/js/app.8de2a662.js" as="script">
    <link rel="stylesheet" href="/assets/css/styles.e0095a00.css">
  </head>
  <body>
    <div id="app"><!--[--><div class="theme-container"><header class="navbar"><div class="toggle-sidebar-button"><svg class="icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div><span><a href="/" class=""><img class="logo" src="/hero-c.png" alt="众里千寻"><span class="site-name can-hide">众里千寻</span></a></span><div class="navbar-links-wrapper" style=""><!--[--><!--]--><nav class="navbar-links can-hide"><!--[--><div class="navbar-links-item"><a href="/courses/" class="nav-link" aria-label="学习笔记"><!--[--><!--]--> 学习笔记 <!--[--><!--]--></a></div><div class="navbar-links-item"><a href="/solutions/" class="nav-link router-link-active" aria-label="解决方案"><!--[--><!--]--> 解决方案 <!--[--><!--]--></a></div><div class="navbar-links-item"><a href="/tools/" class="nav-link" aria-label="开发利器"><!--[--><!--]--> 开发利器 <!--[--><!--]--></a></div><div class="navbar-links-item"><a href="/code-reading/" class="nav-link" aria-label="源码解读"><!--[--><!--]--> 源码解读 <!--[--><!--]--></a></div><div class="navbar-links-item"><a href="/posts/" class="nav-link" aria-label="最新消息"><!--[--><!--]--> 最新消息 <!--[--><!--]--></a></div><div class="navbar-links-item"><a class="nav-link external" href="https://github.com/everfind" rel="noopener noreferrer" target="_blank" aria-label="GitHub"><!--[--><!--]--> GitHub <span><svg class="icon outbound" xmlns="http://www.w3.org/2000/svg" ariahidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><!--[--><span class="sr-only">open in new window</span><!--]--></span><!--[--><!--]--></a></div><!--]--></nav><!--[--><!--]--><button class="toggle-dark-button"><svg style="" class="icon" focusable="false" viewBox="0 0 32 32"><path d="M16 12.005a4 4 0 1 1-4 4a4.005 4.005 0 0 1 4-4m0-2a6 6 0 1 0 6 6a6 6 0 0 0-6-6z" fill="currentColor"></path><path d="M5.394 6.813l1.414-1.415l3.506 3.506L8.9 10.318z" fill="currentColor"></path><path d="M2 15.005h5v2H2z" fill="currentColor"></path><path d="M5.394 25.197L8.9 21.691l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 25.005h2v5h-2z" fill="currentColor"></path><path d="M21.687 23.106l1.414-1.415l3.506 3.506l-1.414 1.414z" fill="currentColor"></path><path d="M25 15.005h5v2h-5z" fill="currentColor"></path><path d="M21.687 8.904l3.506-3.506l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 2.005h2v5h-2z" fill="currentColor"></path></svg><svg style="display:none;" class="icon" focusable="false" viewBox="0 0 32 32"><path d="M13.502 5.414a15.075 15.075 0 0 0 11.594 18.194a11.113 11.113 0 0 1-7.975 3.39c-.138 0-.278.005-.418 0a11.094 11.094 0 0 1-3.2-21.584M14.98 3a1.002 1.002 0 0 0-.175.016a13.096 13.096 0 0 0 1.825 25.981c.164.006.328 0 .49 0a13.072 13.072 0 0 0 10.703-5.555a1.01 1.01 0 0 0-.783-1.565A13.08 13.08 0 0 1 15.89 4.38A1.015 1.015 0 0 0 14.98 3z" fill="currentColor"></path></svg></button><form class="search-box" role="search"><input type="search" autocomplete="off" spellcheck="false" value><!----></form></div></header><div class="sidebar-mask"></div><aside class="sidebar"><nav class="navbar-links"><!--[--><div class="navbar-links-item"><a href="/courses/" class="nav-link" aria-label="学习笔记"><!--[--><!--]--> 学习笔记 <!--[--><!--]--></a></div><div class="navbar-links-item"><a href="/solutions/" class="nav-link router-link-active" aria-label="解决方案"><!--[--><!--]--> 解决方案 <!--[--><!--]--></a></div><div class="navbar-links-item"><a href="/tools/" class="nav-link" aria-label="开发利器"><!--[--><!--]--> 开发利器 <!--[--><!--]--></a></div><div class="navbar-links-item"><a href="/code-reading/" class="nav-link" aria-label="源码解读"><!--[--><!--]--> 源码解读 <!--[--><!--]--></a></div><div class="navbar-links-item"><a href="/posts/" class="nav-link" aria-label="最新消息"><!--[--><!--]--> 最新消息 <!--[--><!--]--></a></div><div class="navbar-links-item"><a class="nav-link external" href="https://github.com/everfind" rel="noopener noreferrer" target="_blank" aria-label="GitHub"><!--[--><!--]--> GitHub <span><svg class="icon outbound" xmlns="http://www.w3.org/2000/svg" ariahidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><!--[--><span class="sr-only">open in new window</span><!--]--></span><!--[--><!--]--></a></div><!--]--></nav><!--[--><!--]--><ul class="sidebar-links"><!--[--><!--[--><p class="sidebar-heading sidebar-item">Schema 合成管理系统</p><ul class=""><li><!--[--><a aria-current="page" href="/solutions/graphql/schema-composition.html#schema-的合成校验" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="Schema 的合成校验"><!--[--><!--]--> Schema 的合成校验 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a aria-current="page" href="/solutions/graphql/schema-composition.html#数据字段设计" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="数据字段设计"><!--[--><!--]--> 数据字段设计 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a aria-current="page" href="/solutions/graphql/schema-composition.html#与-ci-cd-系统的交互" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="与 CI/CD 系统的交互"><!--[--><!--]--> 与 CI/CD 系统的交互 <!--[--><!--]--></a><ul class="sidebar-sub-items"><li><!--[--><a aria-current="page" href="/solutions/graphql/schema-composition.html#子服务构建时推送-schema" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="子服务构建时推送 Schema"><!--[--><!--]--> 子服务构建时推送 Schema <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a aria-current="page" href="/solutions/graphql/schema-composition.html#子服务启动时确定-schema-是否合法" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="子服务启动时确定 Schema 是否合法"><!--[--><!--]--> 子服务启动时确定 Schema 是否合法 <!--[--><!--]--></a><!----><!--]--></li></ul><!--]--></li><li><!--[--><a aria-current="page" href="/solutions/graphql/schema-composition.html#网关拉取-schema" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="网关拉取 Schema"><!--[--><!--]--> 网关拉取 Schema <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a aria-current="page" href="/solutions/graphql/schema-composition.html#总结" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="总结"><!--[--><!--]--> 总结 <!--[--><!--]--></a><!----><!--]--></li></ul><!--]--><!--]--></ul><!--[--><!--]--></aside><main class="page"><!--[--><!--]--><div class="theme-default-content"><!--[--><p>上一篇我们在说网关的时候，遗留了一个问题，就是通过 <code>serviceList</code> 配置子服务无法实现动态更新。同时，各个子服务的 Schema 在合成的时候可能会出错，比如类型重复定义等。</p><p>因此，我们需要一个独立的 Schema 合成管理系统来处理 Schema 的合成校验、不同环境的隔离、CI/CD 等工程问题。</p><p>首先要说明的是，Apollo 官方提供了一个 <a href="https://www.apollographql.com/docs/studio/" target="_blank" rel="noopener noreferrer">Apollo Studio<span><svg class="icon outbound" xmlns="http://www.w3.org/2000/svg" ariahidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><!--[--><span class="sr-only">open in new window</span><!--]--></span></a> 解决方案，可以解决我们本文讨论的问题。缺点是没有提供自托管（self host）方案，需要将 schema 上传到 Apollo 的服务中。</p><p>本文来探讨实现一个 Schema 合成管理系统。</p><p>在我们这个系统中，存储各个子服务的 Schema，同时提供 Schema 的合并校验能力，将合并后的 Schema 提供给网关使用。</p><p>通常来说，服务部署都会依赖 CI/CD 来实现。因此，我们的 Schema 合成管理系统应该与 CI/CD 对接，而不是手动上传 Schema。</p><h2 id="schema-的合成校验" tabindex="-1"><a class="header-anchor" href="#schema-的合成校验" aria-hidden="true">#</a> Schema 的合成校验</h2><p>在子服务中，我们可以通过如何 GraphQL 查询获取子服务的 Schema 信息。</p><div class="language-graphql ext-graphql line-numbers-mode"><pre class="language-graphql"><code><span class="token keyword">query</span> <span class="token constant">SDL</span> <span class="token punctuation">{</span>
  <span class="token object">_service</span> <span class="token punctuation">{</span>
    <span class="token property">sdl</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>在上传到 Schema 合成管理系统中后，可以通过如下方法校验各个子服务的 Schema 是否合法。</p><div class="language-typescript ext-ts line-numbers-mode"><pre class="language-typescript"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> parse <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;graphql&#39;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> composeAndValidate <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;@apollo/federation&#39;</span><span class="token punctuation">;</span>

<span class="token comment">// serviceList 为查到的所有子服务的 Schema 信息</span>
<span class="token keyword">const</span> serviceDefinitions <span class="token operator">=</span> <span class="token punctuation">[</span>
  <span class="token punctuation">{</span>
    <span class="token keyword">type</span>Defs<span class="token operator">:</span> <span class="token function">parse</span><span class="token punctuation">(</span>service1<span class="token punctuation">.</span>sdl<span class="token punctuation">)</span><span class="token punctuation">,</span>
    name<span class="token operator">:</span> service1<span class="token punctuation">.</span>name<span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span>
    <span class="token keyword">type</span>Defs<span class="token operator">:</span> <span class="token function">parse</span><span class="token punctuation">(</span>service2<span class="token punctuation">.</span>sdl<span class="token punctuation">)</span><span class="token punctuation">,</span>
    name<span class="token operator">:</span> service2<span class="token punctuation">.</span>name<span class="token punctuation">,</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">]</span><span class="token punctuation">;</span>

<span class="token comment">// 获取合成结果</span>
<span class="token keyword">const</span> validateResult <span class="token operator">=</span> <span class="token function">composeAndValidate</span><span class="token punctuation">(</span>serviceDefinitions<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><h2 id="数据字段设计" tabindex="-1"><a class="header-anchor" href="#数据字段设计" aria-hidden="true">#</a> 数据字段设计</h2><p>知道如何获取子服务的 Schema 以及如何进行校验之后，我们来定义系统的数据库表。</p><p>首先定义一张存储各个子服务信息的表。</p><img src="https://www.plantuml.com/plantuml/svg/SoWkIImgAStDuSfFoafDBb48JYqgoqnELQZcKb38J56mLJ0qCWOoyn9pKu4SfQIqDDtq_FoKOjrYY48be6HAQd4oIFBfrBQdankVx5ZxSlgMfnkRditfVTgr4AIW934TA1-jL0hKb9gNegG3D2WnEHl4Z0LA0-c2_Coy4f0P-c3JzTEB4Wio2dEKk6gv783IG0S20000" alt="uml diagram"><p><code>tag</code> 字段可以给每个服务打上不同的标签，方便后续管理。</p><p>再来定义每个服务的 Schema 信息表。</p><img src="https://www.plantuml.com/plantuml/svg/DSux3i8m30RWFQUmidS0PgGEZ6mSe4eJjmrgOcIxNH1tnn5bykFpBxaN3QnRMHsDJumAZziTtWuW9xZ2wNonLf3t776eeQ0j_JXDtKoKf3l4sz6EB9bgypdh4AaKAqkGfMcagbYrgQJrFpQX5t9GuYC8lo2oTn_NOqtssXS0" alt="uml diagram"><p>在 SDL 表中，除了记录 Schema 的 <code>content</code> 字段以外，我们使用 <code>git_commit_hash</code> 来作为每次发布的版本号，同时记录提交人，方便后续问题的追踪。</p><p>为了方便网关拉取合成后的数据，我们单独定义一张表记录合成后的各服务 Schema 信息。</p><img src="https://www.plantuml.com/plantuml/svg/SoWkIImgAStDuSfFoafDBb48AitBoynBZtVEpqlBJ5Uevb9Go4nHi5KmD386CejJYyeoarFZyn9pKu62IabfQRhf-VafnRfG6IMWehBKekBC_3oGV7fcINnoVcukaCf8BCu0oQRcbO5a2ehobRXgkRZoyajI5PIUzgzwDgVpsOA5BrVrl6oOzM9_-vFTIvzEw7lMsVjapwndixSycxRXUT_wfukQdoreLr98B5PmzGkBz_CFSUL2Sx2kBaBA8JKl1UWr0000" alt="uml diagram"><p>不同的环境都会有网关，因此通过 <code>env</code> 字段记录环境。</p><h2 id="与-ci-cd-系统的交互" tabindex="-1"><a class="header-anchor" href="#与-ci-cd-系统的交互" aria-hidden="true">#</a> 与 CI/CD 系统的交互</h2><p>前面说到，Schema 合成管理系统应该与 CI/CD 对接，杜绝个人上传 Schema 的操作。因此，我们需要定义与 CI/CD 的交过流程。</p><h3 id="子服务构建时推送-schema" tabindex="-1"><a class="header-anchor" href="#子服务构建时推送-schema" aria-hidden="true">#</a> 子服务构建时推送 Schema</h3><p>如下是子服务构建时与 Schema 合成管理系统的交互时序图。</p><img src="https://www.plantuml.com/plantuml/svg/SoWkIImgAStDuKeiBSdFAyrDIYtYuYe0YcKcPnOavfKeA3bxAYaa5YiuUw8A1oTdfEOcAZoTqF6iOyBpTGkVJsXxlddtyztpmQg3FOEvk1AJIpBB4ajIGNgvd3qLTEs0B2k5P_DQdkxUzNpAVA16XM0N7oI5O6qGbK2cbSAJ7LrFzYm0AL9Gq5PutjdnRCwQf_tRkO2I2hfWuv0DVhvmtTDrio360yr-sWMqOTgBXjQdIpQ-sBAKoo4rBmNeKm00" alt="uml diagram"><h3 id="子服务启动时确定-schema-是否合法" tabindex="-1"><a class="header-anchor" href="#子服务启动时确定-schema-是否合法" aria-hidden="true">#</a> 子服务启动时确定 Schema 是否合法</h3><p>如下是子服务启动时与 Schema 合成管理系统的交互时序图。</p><img src="https://www.plantuml.com/plantuml/svg/NP7DIiD058NtynH3j-8BT25Tk17SvGd6PBI1DYd9f6j1gsbewu2bYpQqZIYAQ59H_0leo_JEnBTmGcfetGoNcVETU-RUcik8mxnc0n6FsPRNFA0EGYrrP-fcYrWCL-2HYx0FGLJ1nCKQTTgcJZSbcbwdJOA1-yBdCeuaFvFFgKnd1RAd8KHqPhO9ewK1MXLuUoTNLB4S971r8kRdU0lBhY_21xXuKtNH77XVtYxMVN9NTPIyw7w1lu3a0pw79I_7frZRtSVPzoIBUc8U_Tpta6KhtZ6FwWpRXmMyV1z0vtMPZe3tYY0vwQuYkaPZqw5iN0YgwdK8awbCByKqHCYW_sAkVVMFa54CyHXu0i6TcXe4C-6FikCEN3zbBpUeHYr3hUKN" alt="uml diagram"><p>之所以要在子服务启动时才校验 Schema 是否合法，是因为服务部署需要考虑环境，而 CI 在构建打包的时候应该与环境无关，因此，我们在服务启动时做校验。</p><h2 id="网关拉取-schema" tabindex="-1"><a class="header-anchor" href="#网关拉取-schema" aria-hidden="true">#</a> 网关拉取 Schema</h2><p>网关是对外提供服务的，需要拉取最新可用的全部 Schema。前面的设计中，Schema 合成管理系统的 <code>Running_Config</code> 表记录了当前可用的所有子服务的 Schema。网关只需要从 Schema 合成管理系统中拉取这个信息就可以了。</p><img src="https://www.plantuml.com/plantuml/svg/SoWkIImgAStDuKeiBSdFAyrDIYtYuYe0YcKcPnOavfKeABadbgIM9rOgAIGMAxY7eye59sUavYOgF9tGyQnZmlDr2vzFQ7k-UVVptVF1geCzWxcu4fDBCik0He3qShc7A-ZQWSIj59ujQ7--Tf-2jiBpllLF5pKZAGHh0n98IXU-NDMZ4EpYmvMN3rHGb9cUKQAGdmQLtRtmnRRD4EEUpsfvrjdmR4xdipczJxiM0haWNGelziz-iR07OWpSQFTmAw34bAUpvxrixNs-TzsJ_GkVDQxdIab5TGZ4oI35psPlUJPj0ufYXzIy563W0G00" alt="uml diagram"><p>在拉取到配置以后，可以通过如下方式实现自动更新网关的 Schema 信息。</p><div class="language-typescript ext-ts line-numbers-mode"><pre class="language-typescript"><code><span class="token keyword">const</span> graphqlGatewayModule <span class="token operator">=</span> GraphQLGatewayModule<span class="token punctuation">.</span><span class="token function">forRootAsync</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token function-variable function">useFactory</span><span class="token operator">:</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span><span class="token punctuation">{</span>
    server<span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token comment">// 其他配置项</span>
      path<span class="token operator">:</span> <span class="token string">&#39;/bff/graphql&#39;</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    gateway<span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token comment">// 一分钟轮询时间</span>
      experimental_pollInterval<span class="token operator">:</span> <span class="token number">60</span> <span class="token operator">*</span> <span class="token number">1000</span><span class="token punctuation">,</span>
      experimental_updateServiceDefinitions<span class="token operator">:</span> updateServicesDefinitions<span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p>我们将原来的 <code>serviceList</code> 换成 <code>updateServicesDefinitions</code>，而 <code>updateServicesDefinitions</code> 负责从 Schema 合成管理系统拉取最新的 Schema 信息返回给网关。</p><div class="language-typescript ext-ts line-numbers-mode"><pre class="language-typescript"><code><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">updateServicesDefinitions</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> data <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">&#39;https://gateway-running-config-endpoint&#39;</span><span class="token punctuation">)</span>
  <span class="token keyword">const</span> serviceDefinitions <span class="token operator">=</span> data<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">{</span> name<span class="token punctuation">,</span> url<span class="token punctuation">,</span> sdl <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token keyword">type</span>Defs<span class="token operator">:</span> <span class="token function">parse</span><span class="token punctuation">(</span>sdl<span class="token punctuation">)</span><span class="token punctuation">,</span>
    name<span class="token punctuation">,</span>
    url<span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> <span class="token punctuation">{</span>
    serviceDefinitions<span class="token punctuation">,</span>
    isNewSchema<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p>通过这个方法就可以实现网关自动拉取最新的 Schema 信息了。</p><h2 id="总结" tabindex="-1"><a class="header-anchor" href="#总结" aria-hidden="true">#</a> 总结</h2><p>我们先探索了获取子服务 Schema，并进行合成校验的方法，这是构建 Schema 合成管理系统的技术基石。然后我们设计了实现最简功能所需的数据库表。</p><p>完成了 Schema 合成管理系统的内部设计以后，我们对 CI/CD 以及网关如何与 Schema 合成管理系统交互做了定义和说明。</p><div style="display:flex;align-items:center;justify-content:center;"><p style="text-align:center;margin-top:10px;color:#999;"><img src="/qrcode-c.jpg" style="width:200px;height:200px;display:block;margin:10px auto;opacity:0.8;">关注微信公众号，获取最新推送~</p><p style="text-align:center;margin-top:10px;color:#999;"><img src="/card-c.jpeg" style="width:200px;height:200px;display:block;margin:10px auto;opacity:0.8;">加微信，深入交流~</p></div><!--]--></div><footer class="page-meta"><!----><!----><!----></footer><!----><!--[--><!--]--></main></div><!----><!----><!--]--></div>
    <script src="/assets/js/runtime~app.fa50ff6a.js" defer></script><script src="/assets/js/3767.b5b9e7ce.js" defer></script><script src="/assets/js/app.8de2a662.js" defer></script>
  </body>
</html>
