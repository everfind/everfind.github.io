<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <link rel="icon" href="/favicon.ico"><link rel="manifest" href="/manifest.webmanifest"><meta name="theme-color" content="#5397d2"><script>
      var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?e772d8d7735057378a672ae311e9bf20";
  var s = document.getElementsByTagName("script")[0];
  s.parentNode.insertBefore(hm, s);
})();
    </script><title>Dataloader 批处理能力解读 | 众里千寻</title><meta name="description" content="批处理是 Dataloader 的首要核心能力，本篇文章会对批处理的功能以及如何实现这些功能做详细地介绍。"><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><meta name="generator" content="VuePress 2.0.0-beta.22">
    <link rel="preload" href="/assets/js/runtime~app.fa50ff6a.js" as="script"><link rel="preload" href="/assets/css/styles.e0095a00.css" as="style"><link rel="preload" href="/assets/js/3767.b5b9e7ce.js" as="script"><link rel="preload" href="/assets/js/app.8de2a662.js" as="script">
    <link rel="stylesheet" href="/assets/css/styles.e0095a00.css">
  </head>
  <body>
    <div id="app"><!--[--><div class="theme-container"><header class="navbar"><div class="toggle-sidebar-button"><svg class="icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div><span><a href="/" class=""><img class="logo" src="/hero-c.png" alt="众里千寻"><span class="site-name can-hide">众里千寻</span></a></span><div class="navbar-links-wrapper" style=""><!--[--><!--]--><nav class="navbar-links can-hide"><!--[--><div class="navbar-links-item"><a href="/courses/" class="nav-link" aria-label="学习笔记"><!--[--><!--]--> 学习笔记 <!--[--><!--]--></a></div><div class="navbar-links-item"><a href="/solutions/" class="nav-link" aria-label="解决方案"><!--[--><!--]--> 解决方案 <!--[--><!--]--></a></div><div class="navbar-links-item"><a href="/tools/" class="nav-link" aria-label="开发利器"><!--[--><!--]--> 开发利器 <!--[--><!--]--></a></div><div class="navbar-links-item"><a href="/code-reading/" class="nav-link router-link-active" aria-label="源码解读"><!--[--><!--]--> 源码解读 <!--[--><!--]--></a></div><div class="navbar-links-item"><a href="/posts/" class="nav-link" aria-label="最新消息"><!--[--><!--]--> 最新消息 <!--[--><!--]--></a></div><div class="navbar-links-item"><a class="nav-link external" href="https://github.com/everfind" rel="noopener noreferrer" target="_blank" aria-label="GitHub"><!--[--><!--]--> GitHub <span><svg class="icon outbound" xmlns="http://www.w3.org/2000/svg" ariahidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><!--[--><span class="sr-only">open in new window</span><!--]--></span><!--[--><!--]--></a></div><!--]--></nav><!--[--><!--]--><button class="toggle-dark-button"><svg style="" class="icon" focusable="false" viewBox="0 0 32 32"><path d="M16 12.005a4 4 0 1 1-4 4a4.005 4.005 0 0 1 4-4m0-2a6 6 0 1 0 6 6a6 6 0 0 0-6-6z" fill="currentColor"></path><path d="M5.394 6.813l1.414-1.415l3.506 3.506L8.9 10.318z" fill="currentColor"></path><path d="M2 15.005h5v2H2z" fill="currentColor"></path><path d="M5.394 25.197L8.9 21.691l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 25.005h2v5h-2z" fill="currentColor"></path><path d="M21.687 23.106l1.414-1.415l3.506 3.506l-1.414 1.414z" fill="currentColor"></path><path d="M25 15.005h5v2h-5z" fill="currentColor"></path><path d="M21.687 8.904l3.506-3.506l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 2.005h2v5h-2z" fill="currentColor"></path></svg><svg style="display:none;" class="icon" focusable="false" viewBox="0 0 32 32"><path d="M13.502 5.414a15.075 15.075 0 0 0 11.594 18.194a11.113 11.113 0 0 1-7.975 3.39c-.138 0-.278.005-.418 0a11.094 11.094 0 0 1-3.2-21.584M14.98 3a1.002 1.002 0 0 0-.175.016a13.096 13.096 0 0 0 1.825 25.981c.164.006.328 0 .49 0a13.072 13.072 0 0 0 10.703-5.555a1.01 1.01 0 0 0-.783-1.565A13.08 13.08 0 0 1 15.89 4.38A1.015 1.015 0 0 0 14.98 3z" fill="currentColor"></path></svg></button><form class="search-box" role="search"><input type="search" autocomplete="off" spellcheck="false" value><!----></form></div></header><div class="sidebar-mask"></div><aside class="sidebar"><nav class="navbar-links"><!--[--><div class="navbar-links-item"><a href="/courses/" class="nav-link" aria-label="学习笔记"><!--[--><!--]--> 学习笔记 <!--[--><!--]--></a></div><div class="navbar-links-item"><a href="/solutions/" class="nav-link" aria-label="解决方案"><!--[--><!--]--> 解决方案 <!--[--><!--]--></a></div><div class="navbar-links-item"><a href="/tools/" class="nav-link" aria-label="开发利器"><!--[--><!--]--> 开发利器 <!--[--><!--]--></a></div><div class="navbar-links-item"><a href="/code-reading/" class="nav-link router-link-active" aria-label="源码解读"><!--[--><!--]--> 源码解读 <!--[--><!--]--></a></div><div class="navbar-links-item"><a href="/posts/" class="nav-link" aria-label="最新消息"><!--[--><!--]--> 最新消息 <!--[--><!--]--></a></div><div class="navbar-links-item"><a class="nav-link external" href="https://github.com/everfind" rel="noopener noreferrer" target="_blank" aria-label="GitHub"><!--[--><!--]--> GitHub <span><svg class="icon outbound" xmlns="http://www.w3.org/2000/svg" ariahidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><!--[--><span class="sr-only">open in new window</span><!--]--></span><!--[--><!--]--></a></div><!--]--></nav><!--[--><!--]--><ul class="sidebar-links"><!--[--><!--[--><p class="sidebar-heading sidebar-item">Dataloader 批处理能力解读</p><ul class=""><li><!--[--><a aria-current="page" href="/code-reading/dataloader/batch.html#什么是-batch" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="什么是 Batch"><!--[--><!--]--> 什么是 Batch <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a aria-current="page" href="/code-reading/dataloader/batch.html#batchloadfn-批量请求函数" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="batchLoadFn 批量请求函数"><!--[--><!--]--> batchLoadFn 批量请求函数 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a aria-current="page" href="/code-reading/dataloader/batch.html#load-函数" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="load 函数"><!--[--><!--]--> load 函数 <!--[--><!--]--></a><ul class="sidebar-sub-items"><li><!--[--><a aria-current="page" href="/code-reading/dataloader/batch.html#getcurrentbatch" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="getCurrentBatch"><!--[--><!--]--> getCurrentBatch <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a aria-current="page" href="/code-reading/dataloader/batch.html#dispatchbatch" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="dispatchBatch"><!--[--><!--]--> dispatchBatch <!--[--><!--]--></a><!----><!--]--></li></ul><!--]--></li><li><!--[--><a aria-current="page" href="/code-reading/dataloader/batch.html#批量调度策略" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="批量调度策略"><!--[--><!--]--> 批量调度策略 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a aria-current="page" href="/code-reading/dataloader/batch.html#loadmany-函数" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="loadMany 函数"><!--[--><!--]--> loadMany 函数 <!--[--><!--]--></a><!----><!--]--></li></ul><!--]--><!--]--></ul><!--[--><!--]--></aside><main class="page"><!--[--><!--]--><div class="theme-default-content"><!--[--><p>Dataloader 的批处理能力，可以实现在一个周期内将多次数据请求进行合并，最终只向远程数据源发送一次请求。这个周期不是固定的，Dataloader 的默认实现是 NodeJS 事件循环的一个循环周期，用户也可以自定义周期。</p><p>如下是 Dataloader 的构造函数的签名：</p><div class="language-typescript ext-ts line-numbers-mode"><pre class="language-typescript"><code><span class="token function">constructor</span><span class="token punctuation">(</span>batchLoadFn<span class="token operator">:</span> DataLoader<span class="token punctuation">.</span>BatchLoadFn<span class="token operator">&lt;</span><span class="token constant">K</span><span class="token punctuation">,</span> <span class="token constant">V</span><span class="token operator">&gt;</span><span class="token punctuation">,</span> options<span class="token operator">?</span><span class="token operator">:</span> DataLoader<span class="token punctuation">.</span>Options<span class="token operator">&lt;</span><span class="token constant">K</span><span class="token punctuation">,</span> <span class="token constant">V</span><span class="token punctuation">,</span> <span class="token constant">C</span><span class="token operator">&gt;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br></div></div><p>首先是一个批量请求函数 <code>batchLoadFn</code>，告诉 Dataloader 如何批量发起请求。其次 <code>options</code> 参数中有是三个配置项关于批处理的：</p><ul><li>batch 是否启用批量请求，false 为不启用，每次数据请求都会向远程数据源发起请求。默认为 true</li><li>maxBatchSize 一次最多可以请求多少个数据，超过这个数字的请求会放到下一批请求中。默认不限制。</li><li>batchScheduleFn 批量调度函数，告诉 Dataloader 什么时候发起批量请求。</li></ul><p>Dataloader 提供了两个函数来获取数据：</p><ul><li><code>load(key: K): Promise&lt;V&gt;;</code></li><li><code>loadMany(keys: ArrayLike&lt;K&gt;): Promise&lt;Array&lt;V | Error&gt;&gt;;</code></li></ul><p>显而易见，一个是一次获取一个，一个是一次获取多个。</p><p>在讲这两个函数的具体实现之前，我们先来了解下 Dataloader 中的基本概念。</p><h2 id="什么是-batch" tabindex="-1"><a class="header-anchor" href="#什么是-batch" aria-hidden="true">#</a> 什么是 Batch</h2><p>前面说过，Dataloader 会搜集一个周期内的所有数据调用，然后合并成一个数据请求。<code>Batch</code> 对象就是这个能力的载体。</p><div class="language-typescript ext-ts line-numbers-mode"><pre class="language-typescript"><code><span class="token keyword">type</span> <span class="token class-name">Batch<span class="token operator">&lt;</span><span class="token constant">K</span><span class="token punctuation">,</span> <span class="token constant">V</span><span class="token operator">&gt;</span></span> <span class="token operator">=</span> <span class="token punctuation">{</span>
  hasDispatched<span class="token operator">:</span> <span class="token builtin">boolean</span><span class="token punctuation">;</span>
  keys<span class="token operator">:</span> <span class="token builtin">Array</span><span class="token operator">&lt;</span><span class="token constant">K</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
  callbacks<span class="token operator">:</span> <span class="token builtin">Array</span><span class="token operator">&lt;</span><span class="token punctuation">{</span>
    <span class="token function-variable function">resolve</span><span class="token operator">:</span> <span class="token punctuation">(</span>value<span class="token operator">:</span> <span class="token constant">V</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">void</span><span class="token punctuation">;</span>
    <span class="token function-variable function">reject</span><span class="token operator">:</span> <span class="token punctuation">(</span>error<span class="token operator">:</span> Error<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">void</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
  cacheHits<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">Array</span><span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">void</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>这是 <code>Batch</code> 的类型定义，<code>hasDispatched</code> 表示当前批的请求是否已经发出。<code>keys</code> 中存放着需要通过请求获取数据的 <code>key</code> 列表。<code>callbacks</code> 是对应于每一个 <code>key</code> 的请求回调，且是一一对应的关系。<code>cacheHits</code> 是命中缓存的数据列表。</p><p>Dataloader 会尽量利用缓存不重复请求相同的数据。也就是说，假如一个周期内有 10 个数据请求，其中有两个会命中缓存，那么 <code>keys</code> 的长度就是 8，<code>cacheHits</code> 的长度是 2。</p><p>举个例子，假如我们需要查询用户的好友的好友。用户 A 有好友 B 和 C。用户 D 有好友 C 和 E。假设我们有一个 <code>loaderUser</code> 的接口查询用户信息。那么通常情况下，需要查询 6（3 + 3）次。使用了 Dataloader 的话，只需要请求 5（3 + 2）次，因为 A 和 D 有个共同好友 C，第二次查询用户 C 的时候会命中缓存。</p><p>Dataloader 会将一个周期内的数据请求都存放在一个 <code>Batch</code> 对象内（如果不超过 <code>maxBatchSize</code> 的话），之后通过调用构造函数传入的 <code>batchLoadFn</code> 一次查询所有的数据。</p><h2 id="batchloadfn-批量请求函数" tabindex="-1"><a class="header-anchor" href="#batchloadfn-批量请求函数" aria-hidden="true">#</a> batchLoadFn 批量请求函数</h2><p>先看一个批量函数的 demo。</p><div class="language-typescript ext-ts line-numbers-mode"><pre class="language-typescript"><code><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">batchFunction</span><span class="token punctuation">(</span>keys<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> results <span class="token operator">=</span> <span class="token keyword">await</span> db<span class="token punctuation">.</span><span class="token function">fetchAllKeys</span><span class="token punctuation">(</span>keys<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> keys<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> results<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">||</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">No result for </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>key<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> loader <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DataLoader</span><span class="token punctuation">(</span>batchFunction<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>Dataloader 对 <code>batchLoadFn</code> 函数有两个约束：</p><ul><li>函数的返回数组长度必须与 <code>keys</code> 数组长度一致。</li><li>函数的返回数组内的元素必须与 <code>keys</code> 内的元素一一对应。</li></ul><p>也就是说，假如请求的 <code>keys</code> 列表为 <code>[2, 9, 6, 1]</code>，如果数据接口只返回了</p><div class="language-typescript ext-ts line-numbers-mode"><pre class="language-typescript"><code><span class="token punctuation">{</span> id<span class="token operator">:</span> <span class="token number">9</span><span class="token punctuation">,</span> name<span class="token operator">:</span> <span class="token string">&#39;Chicago&#39;</span> <span class="token punctuation">}</span>
<span class="token punctuation">{</span> id<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span> name<span class="token operator">:</span> <span class="token string">&#39;New York&#39;</span> <span class="token punctuation">}</span>
<span class="token punctuation">{</span> id<span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span> name<span class="token operator">:</span> <span class="token string">&#39;San Francisco&#39;</span> <span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>那么我们的 <code>batchLoadFn</code> 需要返回：</p><div class="language-typescript ext-ts line-numbers-mode"><pre class="language-typescript"><code><span class="token punctuation">[</span>
  <span class="token punctuation">{</span> id<span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span> name<span class="token operator">:</span> <span class="token string">&#39;San Francisco&#39;</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span> id<span class="token operator">:</span> <span class="token number">9</span><span class="token punctuation">,</span> name<span class="token operator">:</span> <span class="token string">&#39;Chicago&#39;</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token comment">// 或者 `new Error()`</span>
  <span class="token punctuation">{</span> id<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span> name<span class="token operator">:</span> <span class="token string">&#39;New York&#39;</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">]</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>注意，<code>batchLoadFn</code> 需要返回一个 Promise。</p><h2 id="load-函数" tabindex="-1"><a class="header-anchor" href="#load-函数" aria-hidden="true">#</a> <code>load</code> 函数</h2><p><code>load</code> 函数的签名是 <code>load(key: K): Promise&lt;V&gt;</code>，关键代码如下：</p><div class="language-typescript ext-ts line-numbers-mode"><pre class="language-typescript"><code><span class="token function">load</span><span class="token punctuation">(</span>key<span class="token operator">:</span> <span class="token constant">K</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span><span class="token constant">V</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> batch <span class="token operator">=</span> <span class="token function">getCurrentBatch</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">var</span> cacheMap <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_cacheMap<span class="token punctuation">;</span>
  <span class="token keyword">var</span> cacheKey <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_cacheKeyFn</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// If caching and there is a cache-hit, return cached Promise.</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>cacheMap<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> cachedPromise <span class="token operator">=</span> cacheMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>cacheKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>cachedPromise<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">var</span> cacheHits <span class="token operator">=</span> batch<span class="token punctuation">.</span>cacheHits <span class="token operator">||</span> <span class="token punctuation">(</span>batch<span class="token punctuation">.</span>cacheHits <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name"><span class="token builtin">Promise</span></span><span class="token punctuation">(</span>resolve <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        cacheHits<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          <span class="token function">resolve</span><span class="token punctuation">(</span>cachedPromise<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// Otherwise, produce a new Promise for this key, and enqueue it to be</span>
  <span class="token comment">// dispatched along with the current batch.</span>
  batch<span class="token punctuation">.</span>keys<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">var</span> promise <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name"><span class="token builtin">Promise</span></span><span class="token punctuation">(</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    batch<span class="token punctuation">.</span>callbacks<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span> resolve<span class="token punctuation">,</span> reject <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// If caching, cache this promise.</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>cacheMap<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    cacheMap<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>cacheKey<span class="token punctuation">,</span> promise<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> promise<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br></div></div><p>我们可以看到，<code>load</code> 函数首先通过 <code>getCurrentBatch</code> 获取了当前的 <code>Batch</code> 对象。之后检查缓存是否存在，如果缓存存在，并且要请求的这个 <code>key</code> 命中缓存，则将已经缓存的 promise 放到 <code>Batch</code> 对象的 <code>cacheHits</code> 数组中去。<code>load</code> 函数本身会返回一个 Promise，在这个 Promise 中返回被缓存的 promise。</p><p>如果没有命中缓存，即需要发送请求获取数据，则将 <code>key</code> 放入到 <code>Batch</code> 对象的 <code>keys</code> 数组中去，同时新建一个 Promise，并将它的 <code>resolve</code> 和 <code>reject</code> 放到 <code>Batch</code> 对象的 <code>callbacks</code> 中。最后在返回这个 Promise 之前，还需要将 Promise 放入到缓存中，这样后面的相同请求可以命中缓存。</p><p>需要注意的是，<code>cacheHits</code> 是一组函数，函数中包装了 <code>load</code> 函数返回的 Promise 的 <code>resolve</code> 和 <code>reject</code> 回调。而 <code>callbacks</code> 中保存的是一个记录了 <code>load</code> 函数返回的 Promise 的 <code>resolve</code> 和 <code>reject</code> 回调的对象。这样，当批量函数返回的时候，通过调用 <code>cacheHits</code> 中的函数或者 <code>callbacks</code> 中对象保存的回调，就能改变 <code>load</code> 函数返回的 Promise 的状态了。</p><h3 id="getcurrentbatch" tabindex="-1"><a class="header-anchor" href="#getcurrentbatch" aria-hidden="true">#</a> <code>getCurrentBatch</code></h3><p>我们现在来看 <code>getCurrentBatch</code> 的实现。</p><p><code>getCurrentBatch</code> 函数代码如下：</p><div class="language-typescript ext-ts line-numbers-mode"><pre class="language-typescript"><code><span class="token keyword">function</span> <span class="token generic-function"><span class="token function">getCurrentBatch</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token constant">K</span><span class="token punctuation">,</span> <span class="token constant">V</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>loader<span class="token operator">:</span> DataLoader<span class="token operator">&lt;</span><span class="token constant">K</span><span class="token punctuation">,</span> <span class="token constant">V</span><span class="token punctuation">,</span> <span class="token builtin">any</span><span class="token operator">&gt;</span><span class="token punctuation">)</span><span class="token operator">:</span> Batch<span class="token operator">&lt;</span><span class="token constant">K</span><span class="token punctuation">,</span> <span class="token constant">V</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// If there is an existing batch which has not yet dispatched and is within</span>
  <span class="token comment">// the limit of the batch size, then return it.</span>
  <span class="token keyword">var</span> existingBatch <span class="token operator">=</span> loader<span class="token punctuation">.</span>_batch<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>
    existingBatch <span class="token operator">!==</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span>
    <span class="token operator">!</span>existingBatch<span class="token punctuation">.</span>hasDispatched <span class="token operator">&amp;&amp;</span>
    existingBatch<span class="token punctuation">.</span>keys<span class="token punctuation">.</span>length <span class="token operator">&lt;</span> loader<span class="token punctuation">.</span>_maxBatchSize <span class="token operator">&amp;&amp;</span>
    <span class="token punctuation">(</span><span class="token operator">!</span>existingBatch<span class="token punctuation">.</span>cacheHits <span class="token operator">||</span>
      existingBatch<span class="token punctuation">.</span>cacheHits<span class="token punctuation">.</span>length <span class="token operator">&lt;</span> loader<span class="token punctuation">.</span>_maxBatchSize<span class="token punctuation">)</span>
  <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> existingBatch<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// Otherwise, create a new batch for this loader.</span>
  <span class="token keyword">var</span> newBatch <span class="token operator">=</span> <span class="token punctuation">{</span> hasDispatched<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span> keys<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> callbacks<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token comment">// Store it on the loader so it may be reused.</span>
  loader<span class="token punctuation">.</span>_batch <span class="token operator">=</span> newBatch<span class="token punctuation">;</span>

  <span class="token comment">// Then schedule a task to dispatch this batch of requests.</span>
  loader<span class="token punctuation">.</span><span class="token function">_batchScheduleFn</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token function">dispatchBatch</span><span class="token punctuation">(</span>loader<span class="token punctuation">,</span> newBatch<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> newBatch<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br></div></div><p><code>getCurrentBatch</code> 首先会判断当前 Dataloader 实例上是否已经有 <code>Batch</code> 对象，并且当前 <code>Batch</code> 还没有发送请求，同时还要检查当前需要发请求的 <code>keys</code> 长度或者命中了缓存的请求数组长度小于 <code>maxBatchSize</code>，如果这些条件都成立，则返回已经存在的 <code>Batch</code> 对象，否则新建一个。</p><p>新建的 <code>Batch</code> 对象会存放在当前 Dataloader 实例上以便复用。同时，会使用当前 Dataloader 实例的批处理调度函数 <code>batchScheduleFn</code> 来调度新创建的 <code>Batch</code> 对象。</p><p>现在汇总一下，<code>load</code> 函数会构建或获取（已存在的）一个 <code>Batch</code> 对象，如果 <code>key</code> 命中缓存，就返回缓存的 Promise。如果没有命中，则新建一个 Promise，然后将设置 <code>Batch</code> 对象的 <code>keys</code> 和 <code>callbacks</code>，使得在批处理结束后能正确的改变 Promise 的状态，返回数据。</p><p>在 <code>Batch</code> 的创建过程中，<code>Batch</code> 对象会将其自己交给 Dataloader 实例的 <code>batchScheduleFn</code> 来调度，<code>batchScheduleFn</code> 会通过 <code>dispatchBatch</code> 函数来发送批量请求。</p><h3 id="dispatchbatch" tabindex="-1"><a class="header-anchor" href="#dispatchbatch" aria-hidden="true">#</a> dispatchBatch</h3><p><code>dispatchBatch</code> 的实现如下：</p><div class="language-typescript ext-ts line-numbers-mode"><pre class="language-typescript"><code><span class="token keyword">function</span> <span class="token generic-function"><span class="token function">dispatchBatch</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token constant">K</span><span class="token punctuation">,</span> <span class="token constant">V</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>
  loader<span class="token operator">:</span> DataLoader<span class="token operator">&lt;</span><span class="token constant">K</span><span class="token punctuation">,</span> <span class="token constant">V</span><span class="token punctuation">,</span> <span class="token builtin">any</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>
  batch<span class="token operator">:</span> Batch<span class="token operator">&lt;</span><span class="token constant">K</span><span class="token punctuation">,</span> <span class="token constant">V</span><span class="token operator">&gt;</span>
<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// Mark this batch as having been dispatched.</span>
  batch<span class="token punctuation">.</span>hasDispatched <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>

  <span class="token comment">// If there&#39;s nothing to load, resolve any cache hits and return early.</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>batch<span class="token punctuation">.</span>keys<span class="token punctuation">.</span>length <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">resolveCacheHits</span><span class="token punctuation">(</span>batch<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// Call the provided batchLoadFn for this loader with the batch&#39;s keys and</span>
  <span class="token comment">// with the loader as the `this` context.</span>
  <span class="token keyword">var</span> batchPromise <span class="token operator">=</span> loader<span class="token punctuation">.</span><span class="token function">_batchLoadFn</span><span class="token punctuation">(</span>batch<span class="token punctuation">.</span>keys<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// Await the resolution of the call to batchLoadFn.</span>
  batchPromise
    <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span>values<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token comment">// Resolve all cache hits in the same micro-task as freshly loaded values.</span>
      <span class="token function">resolveCacheHits</span><span class="token punctuation">(</span>batch<span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">// Step through values, resolving or rejecting each Promise in the batch.</span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> batch<span class="token punctuation">.</span>callbacks<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">var</span> value <span class="token operator">=</span> values<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>value <span class="token keyword">instanceof</span> <span class="token class-name">Error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          batch<span class="token punctuation">.</span>callbacks<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">reject</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
          batch<span class="token punctuation">.</span>callbacks<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token function">failedDispatch</span><span class="token punctuation">(</span>loader<span class="token punctuation">,</span> batch<span class="token punctuation">,</span> error<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br></div></div><p>首先 <code>dispatchBatch</code> 是否需要发送请求，如果 <code>keys</code> 长度为零，即全部命中缓存，则直接调用 <code>resolveCacheHits</code> 并返回。<code>resolveCacheHits</code> 会直接一次调用 <code>Batch</code> 对象中 <code>cacheHits</code> 里面的函数，此时 <code>load</code> 就拿到了缓存的结果（Promise 到了 resolved 的状态）。</p><div class="language-typescript ext-ts line-numbers-mode"><pre class="language-typescript"><code><span class="token keyword">function</span> <span class="token function">resolveCacheHits</span><span class="token punctuation">(</span>batch<span class="token operator">:</span> Batch<span class="token operator">&lt;</span><span class="token builtin">any</span><span class="token punctuation">,</span> <span class="token builtin">any</span><span class="token operator">&gt;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>batch<span class="token punctuation">.</span>cacheHits<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> batch<span class="token punctuation">.</span>cacheHits<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      batch<span class="token punctuation">.</span>cacheHits<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>如果有需要请求的，则使用创建 Dataloader 实例的时候传入的 <code>batchLoadFn</code> 来批量发起请求。</p><p>然后，在 <code>batchLoadFn</code> 返回之后，先通过 <code>resolveCacheHits</code> 返回命中的缓存，之后，依次根据 <code>batchLoadFn</code> 返回的结果，如果出错了则调用 <code>callbacks</code> 中对象的 <code>reject</code>，如果正确返回则调用 <code>callbacks</code> 中对象的 <code>resolve</code>。</p><p>这样就可以将批量请求的结果正确的传递回 <code>load</code> 函数了。</p><p>如果批量请求出错了，则会调用 <code>failedDispatch</code> 函数。</p><div class="language-typescript ext-ts line-numbers-mode"><pre class="language-typescript"><code><span class="token keyword">function</span> <span class="token generic-function"><span class="token function">failedDispatch</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token constant">K</span><span class="token punctuation">,</span> <span class="token constant">V</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>
  loader<span class="token operator">:</span> DataLoader<span class="token operator">&lt;</span><span class="token constant">K</span><span class="token punctuation">,</span> <span class="token constant">V</span><span class="token punctuation">,</span> <span class="token builtin">any</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>
  batch<span class="token operator">:</span> Batch<span class="token operator">&lt;</span><span class="token constant">K</span><span class="token punctuation">,</span> <span class="token constant">V</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>
  error<span class="token operator">:</span> Error
<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// Cache hits are resolved, even though the batch failed.</span>
  <span class="token function">resolveCacheHits</span><span class="token punctuation">(</span>batch<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> batch<span class="token punctuation">.</span>keys<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    loader<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span>batch<span class="token punctuation">.</span>keys<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    batch<span class="token punctuation">.</span>callbacks<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">reject</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p><code>failedDispatch</code> 函数会先返回命中的缓存，之后会为每一个需要请求的 key 返回错误信息，同时会通过 <code>clear</code> 函数清理缓存的信息（因为已经发生了错误）。</p><p>到这里，我们已经知道在调用 <code>load</code> 函数之后发生的所有事情了。但是有一点还没有说清楚，就是批量请求的调度策略。</p><h2 id="批量调度策略" tabindex="-1"><a class="header-anchor" href="#批量调度策略" aria-hidden="true">#</a> 批量调度策略</h2><p>Dataloader 支持自定义调度策略，如果没有指定，则使用默认的，如下。</p><div class="language-typescript ext-ts line-numbers-mode"><pre class="language-typescript"><code><span class="token keyword">var</span> enqueuePostPromiseJob <span class="token operator">=</span>
  <span class="token keyword">typeof</span> process <span class="token operator">===</span> <span class="token string">&#39;object&#39;</span> <span class="token operator">&amp;&amp;</span> <span class="token keyword">typeof</span> process<span class="token punctuation">.</span>nextTick <span class="token operator">===</span> <span class="token string">&#39;function&#39;</span>
    <span class="token operator">?</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>fn<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>resolvedPromise<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          resolvedPromise <span class="token operator">=</span> <span class="token builtin">Promise</span><span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        resolvedPromise<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          process<span class="token punctuation">.</span><span class="token function">nextTick</span><span class="token punctuation">(</span>fn<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token operator">:</span> setImmediate <span class="token operator">||</span> setTimeout<span class="token punctuation">;</span>

<span class="token comment">// Private: cached resolved Promise instance</span>
<span class="token keyword">var</span> resolvedPromise<span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p>首先检测环境，如果 <code>process.nextTick</code> 不存在的话，就直接使用 <code>setImmediate</code> 或者 <code>setTimeout</code>。</p><p>如果 <code>process.nextTick</code> 存在的话，通过 Promise 的方式起一个微任务，在这个微任务中告诉 NodeJS 在下一个时间周期内发送批量请求。</p><p>这样的话，Dataloader 就可以在当前时间周期内尽可能多的收集需要请求的 <code>key</code> 了。</p><h2 id="loadmany-函数" tabindex="-1"><a class="header-anchor" href="#loadmany-函数" aria-hidden="true">#</a> loadMany 函数</h2><p><code>load</code> 函数一次只查询一个，<code>loadMany</code> 可以查询多个。下面是 <code>loadMany</code> 函数的代码，可以看到，就是对 <code>load</code> 函数的封装，这里就不在赘述了。</p><div class="language-typescript ext-ts line-numbers-mode"><pre class="language-typescript"><code><span class="token function">loadMany</span><span class="token punctuation">(</span>keys<span class="token operator">:</span> $ReadOnlyArray<span class="token operator">&lt;</span><span class="token constant">K</span><span class="token operator">&gt;</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span><span class="token builtin">Array</span><span class="token operator">&lt;</span><span class="token constant">V</span> <span class="token operator">|</span> Error<span class="token operator">&gt;&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// Support ArrayLike by using only minimal property access</span>
    <span class="token keyword">const</span> loadPromises <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> keys<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      loadPromises<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span>keys<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span>error <span class="token operator">=&gt;</span> error<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token builtin">Promise</span><span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span>loadPromises<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><div style="display:flex;align-items:center;justify-content:center;"><p style="text-align:center;margin-top:10px;color:#999;"><img src="/qrcode-c.jpg" style="width:200px;height:200px;display:block;margin:10px auto;opacity:0.8;">关注微信公众号，获取最新推送~</p><p style="text-align:center;margin-top:10px;color:#999;"><img src="/card-c.jpeg" style="width:200px;height:200px;display:block;margin:10px auto;opacity:0.8;">加微信，深入交流~</p></div><!--]--></div><footer class="page-meta"><!----><!----><!----></footer><!----><!--[--><!--]--></main></div><!----><!----><!--]--></div>
    <script src="/assets/js/runtime~app.fa50ff6a.js" defer></script><script src="/assets/js/3767.b5b9e7ce.js" defer></script><script src="/assets/js/app.8de2a662.js" defer></script>
  </body>
</html>
